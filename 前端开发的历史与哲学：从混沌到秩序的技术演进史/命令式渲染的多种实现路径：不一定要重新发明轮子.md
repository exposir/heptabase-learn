<!--
- [INPUT]: ä¾èµ–å¯¹"å‘½ä»¤å¼æ¸²æŸ“"çš„å¤šç§å®ç°è·¯å¾„çš„ç†è§£
- [OUTPUT]: æ¾„æ¸…"å‘½ä»¤å¼+åŸºç¡€ç»„ä»¶æ”¹é€ "ä¸ä¸€å®šè¦é‡æ–°å‘æ˜è½®å­ï¼Œåˆ†æä¸åŒå®ç°è·¯å¾„çš„æƒè¡¡
- [POS]: å‰ç«¯å¼€å‘çš„å†å²ä¸å“²å­¦ç›®å½•ä¸‹çš„æŠ€æœ¯æ¾„æ¸…æ–‡æ¡£
- [PROTOCOL]: å˜æ›´æ—¶æ›´æ–°æ­¤å¤´éƒ¨ï¼Œç„¶åæ£€æŸ¥ CLAUDE.md
-->

# å‘½ä»¤å¼æ¸²æŸ“çš„å¤šç§å®ç°è·¯å¾„ï¼šä¸ä¸€å®šè¦é‡æ–°å‘æ˜è½®å­

> æ·±åº¦å‰–æ"å‘½ä»¤å¼+åŸºç¡€ç»„ä»¶æ”¹é€ "çš„ä¸‰ç§å®ç°æ–¹å¼ï¼Œä»¥åŠä½•æ—¶å€¼å¾—è‡ªå»ºçŠ¶æ€ç®¡ç†

## å¼•è¨€ï¼šä¸€ä¸ªè¢«è¯¯å¯¼çš„å‰æ

åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ï¼Œæˆ‘æŠŠ"å‘½ä»¤å¼+åŸºç¡€ç»„ä»¶æ”¹é€ "ç­‰åŒäº"è‡ªå·±å®ç° React çŠ¶æ€ç®¡ç†"ï¼š

```typescript
// æˆ‘ä¹‹å‰å»ºè®®çš„æ–¹æ¡ˆï¼ˆè‡ªå»ºçŠ¶æ€ç®¡ç†ï¼‰
class LightweightStateManager {
  useState(cellId, key, initialValue) { ... }
  useContext(cellId, contextKey) { ... }
  // ... 6 å‘¨å¼€å‘
}
```

**ä½†ä½ çš„è´¨ç–‘è®©æˆ‘æ„è¯†åˆ°ä¸€ä¸ªå…³é”®é—®é¢˜**ï¼š

**"å‘½ä»¤å¼æ¸²æŸ“"ä¸ç­‰äº"å¿…é¡»è‡ªå·±å®ç°çŠ¶æ€ç®¡ç†"ï¼**

å®é™…ä¸Šæœ‰å¤šç§å®ç°è·¯å¾„ï¼š

```
è·¯å¾„ 1ï¼šçº¯å‘½ä»¤å¼ï¼ˆæ— çŠ¶æ€ç®¡ç†ï¼‰
â”œâ”€ å®Œå…¨ä¸éœ€è¦ useState/useContext
â”œâ”€ çŠ¶æ€ç”±å¤–éƒ¨ç®¡ç†ï¼ˆRust æˆ–å…¨å±€ Storeï¼‰
â””â”€ æ¸²æŸ“å‡½æ•°æ˜¯çº¯å‡½æ•°

è·¯å¾„ 2ï¼šå€Ÿç”¨ç°æœ‰è½»é‡åº“
â”œâ”€ ä½¿ç”¨ Zustand/Jotai ç­‰è½»é‡çŠ¶æ€åº“
â”œâ”€ ä¸ä¾èµ– Reactï¼Œä½†æœ‰æˆç†Ÿçš„çŠ¶æ€ç®¡ç†
â””â”€ æ— éœ€è‡ªå·±å®ç°

è·¯å¾„ 3ï¼šè‡ªå»ºçŠ¶æ€ç®¡ç†ï¼ˆæˆ‘ä¹‹å‰å»ºè®®çš„ï¼‰
â”œâ”€ å®Œå…¨è‡ªå·±å®ç° useState/useContext
â””â”€ éœ€è¦ 6 å‘¨å¼€å‘

è·¯å¾„ 4ï¼šä¿ç•™ Reactï¼Œåªæ”¹ä¸ºå‘½ä»¤å¼ API
â”œâ”€ ä»ç„¶ç”¨ React Hooks
â”œâ”€ åªæ˜¯è¿”å›å€¼ä» JSX æ”¹ä¸ºå¯¹è±¡
â””â”€ å®é™…ä¸Šå°±æ˜¯ Preact æˆ–ç®€åŒ–ç‰ˆ React
```

**æœ¬æ–‡ç›®æ ‡**ï¼š
1. è¯¦ç»†åˆ†æè¿™å››ç§è·¯å¾„çš„æŠ€æœ¯å®ç°
2. å¯¹æ¯”æˆæœ¬æ”¶ç›Š
3. å›ç­”"ä½•æ—¶å€¼å¾—è‡ªå»ºçŠ¶æ€ç®¡ç†"

---

## ç¬¬ä¸€ç« ï¼šè·¯å¾„ 1 - çº¯å‘½ä»¤å¼ï¼ˆæ— çŠ¶æ€ç®¡ç†ï¼‰

### 1.1 æ ¸å¿ƒæ€æƒ³

**å…³é”®æ´å¯Ÿ**ï¼šå•å…ƒæ ¼æ¸²æŸ“å¯ä»¥æ˜¯**çº¯å‡½æ•°**ï¼ŒçŠ¶æ€ç”±å¤–éƒ¨ç®¡ç†ã€‚

```typescript
// âœ… çº¯å‡½æ•°æ¸²æŸ“ï¼ˆæ— çŠ¶æ€ï¼‰
function renderNameCell(
  cellId: string,
  rowData: any,
  cellState: CellState,  // â† å¤–éƒ¨ä¼ å…¥çš„çŠ¶æ€
  globalState: GlobalState
): CDKElement {
  // æ— éœ€ useStateï¼ŒçŠ¶æ€ä»å‚æ•°è¯»å–
  const textOn = cellState.textOn;
  const extraContext = globalState.extraContext;

  // çº¯å‘½ä»¤å¼åˆ›å»ºå…ƒç´ 
  const elements = [];

  elements.push(CDK.createText({
    text: rowData.name,
    onClick: (e) => {
      // çŠ¶æ€æ›´æ–°é€šçŸ¥å¤–éƒ¨
      cellStateManager.setCellState(cellId, { textOn: true });
    }
  }));

  if (textOn) {
    elements.push(CDK.createIcon({ name: 'edit' }));
  }

  return CDK.createRow({ children: elements });
}
```

### 1.2 çŠ¶æ€ç®¡ç†æ–¹å¼

**æ–¹å¼ 1ï¼šRust ç®¡ç†çŠ¶æ€**

```typescript
// Rust ä¾§å­˜å‚¨çŠ¶æ€
struct CellState {
    text_on: bool,
    cell_on: bool,
}

// Rust è°ƒç”¨æ¸²æŸ“å™¨æ—¶ä¼ å…¥çŠ¶æ€
fn render_cell(cell_id: &str, row_data: &RowData) -> CDKElement {
    let cell_state = self.cell_states.get(cell_id).unwrap_or_default();
    let global_state = self.global_state.clone();

    // è°ƒç”¨ JavaScript æ¸²æŸ“å‡½æ•°
    let cdk_element = js_render_name_cell(
        cell_id,
        row_data,
        &cell_state,    // â† Rust ä¼ å…¥çŠ¶æ€
        &global_state
    );

    cdk_element
}

// JavaScript æ›´æ–°çŠ¶æ€æ—¶è°ƒç”¨ Rust
function updateCellState(cellId: string, newState: Partial<CellState>) {
    window.__RUST_ENGINE__.setCellState(cellId, newState);
}
```

**æ–¹å¼ 2ï¼šå…¨å±€ Store ç®¡ç†çŠ¶æ€ï¼ˆZustand/Jotaiï¼‰**

```typescript
import create from 'zustand';

// ä½¿ç”¨æˆç†Ÿçš„çŠ¶æ€ç®¡ç†åº“
const useCellStore = create((set, get) => ({
  cellStates: new Map<string, CellState>(),

  setCellState: (cellId: string, state: Partial<CellState>) => {
    set((prev) => {
      const newStates = new Map(prev.cellStates);
      const current = newStates.get(cellId) || {};
      newStates.set(cellId, { ...current, ...state });
      return { cellStates: newStates };
    });

    // é€šçŸ¥ Rust é‡æ¸²æŸ“
    window.__RUST_ENGINE__.invalidateCell(cellId);
  },

  getCellState: (cellId: string) => {
    return get().cellStates.get(cellId) || {};
  }
}));

// æ¸²æŸ“å‡½æ•°ä½¿ç”¨ Store
function renderNameCell(cellId: string, rowData: any): CDKElement {
  // ä» Store è¯»å–çŠ¶æ€ï¼ˆé Hook æ–¹å¼ï¼‰
  const cellState = useCellStore.getState().getCellState(cellId);
  const setCellState = useCellStore.getState().setCellState;

  const elements = [];

  elements.push(CDK.createText({
    text: rowData.name,
    onClick: () => setCellState(cellId, { textOn: true })
  }));

  if (cellState.textOn) {
    elements.push(CDK.createIcon({ name: 'edit' }));
  }

  return CDK.createRow({ children: elements });
}
```

### 1.3 ä¼˜åŠ¿ä¸åŠ£åŠ¿

**ä¼˜åŠ¿**ï¼š

```
âœ… æ— éœ€è‡ªå»ºçŠ¶æ€ç®¡ç†ï¼ˆ0 å¼€å‘æˆæœ¬ï¼‰
âœ… æ¸²æŸ“å‡½æ•°æ˜¯çº¯å‡½æ•°ï¼ˆæ˜“æµ‹è¯•ï¼‰
âœ… çŠ¶æ€ç®¡ç†æ¸…æ™°ï¼ˆRust æˆ– Zustandï¼‰
âœ… æ—  React ä¾èµ–ï¼ˆBundle å°ï¼‰
```

**åŠ£åŠ¿**ï¼š

```
âŒ çŠ¶æ€éœ€è¦æ˜¾å¼ä¼ é€’ï¼ˆå‚æ•°å¤šï¼‰
âŒ æ— æ³•ä½¿ç”¨ React ç”Ÿæ€ï¼ˆHooks åº“ï¼‰
âŒ éœ€è¦æ‰‹åŠ¨ç®¡ç†è®¢é˜…ï¼ˆå…¨å±€çŠ¶æ€å˜åŒ– â†’ é‡æ¸²æŸ“ï¼‰
```

### 1.4 ä»£ç é‡ä¼°ç®—

```
Rust ç®¡ç†çŠ¶æ€ï¼ˆæ–¹å¼ 1ï¼‰ï¼š
â”œâ”€ Rust çŠ¶æ€å­˜å‚¨ï¼š~200 è¡Œ
â”œâ”€ JavaScript æ¸²æŸ“å‡½æ•°ï¼š3,068 è¡Œï¼ˆæ”¹å†™ APIï¼‰
â”œâ”€ çŠ¶æ€æ›´æ–°é€šçŸ¥ï¼š~50 è¡Œ
â””â”€ æ€»è®¡ï¼š~3,320 è¡Œï¼ˆ2-3 å‘¨ï¼‰

Zustand ç®¡ç†çŠ¶æ€ï¼ˆæ–¹å¼ 2ï¼‰ï¼š
â”œâ”€ Zustand Store å®šä¹‰ï¼š~100 è¡Œ
â”œâ”€ JavaScript æ¸²æŸ“å‡½æ•°ï¼š3,068 è¡Œï¼ˆæ”¹å†™ APIï¼‰
â”œâ”€ è®¢é˜…é€šçŸ¥ï¼š~50 è¡Œ
â””â”€ æ€»è®¡ï¼š~3,220 è¡Œï¼ˆ2-3 å‘¨ï¼‰
```

---

## ç¬¬äºŒç« ï¼šè·¯å¾„ 2 - å€Ÿç”¨ç°æœ‰è½»é‡åº“

### 2.1 æ ¸å¿ƒæ€æƒ³

**å…³é”®æ´å¯Ÿ**ï¼šä¸éœ€è¦è‡ªå·±å®ç°çŠ¶æ€ç®¡ç†ï¼Œå€Ÿç”¨æˆç†Ÿçš„è½»é‡åº“ã€‚

### 2.2 æ–¹æ¡ˆ 2.1ï¼šZustandï¼ˆæ¨èï¼‰

**Zustand ç‰¹ç‚¹**ï¼š

```
Bundle å¤§å°ï¼š~3KBï¼ˆæ¯” Preact æ›´å°ï¼‰
API é£æ ¼ï¼šç®€æ´ï¼ˆæ— éœ€ Providerï¼‰
æ€§èƒ½ï¼šä¼˜ç§€ï¼ˆé€‰æ‹©æ€§è®¢é˜…ï¼‰
React ä¾èµ–ï¼šå¯é€‰ï¼ˆå¯ä»¥è„±ç¦» React ä½¿ç”¨ï¼‰
```

**ä»£ç ç¤ºä¾‹**ï¼š

```typescript
import create from 'zustand/vanilla'; // â† æ—  React ä¾èµ–ç‰ˆæœ¬

// å®šä¹‰ Storeï¼ˆç±»ä¼¼ Reduxï¼Œä½†æ›´ç®€æ´ï¼‰
const cellStore = create((set, get) => ({
  // çŠ¶æ€
  cellStates: new Map<string, CellState>(),
  globalState: {
    extraContext: {},
    inTreeView: false
  },

  // Actions
  setCellState: (cellId: string, updates: Partial<CellState>) => {
    set((state) => {
      const newStates = new Map(state.cellStates);
      const current = newStates.get(cellId) || {};
      newStates.set(cellId, { ...current, ...updates });
      return { cellStates: newStates };
    });

    // è§¦å‘é‡æ¸²æŸ“
    window.__RUST_ENGINE__.invalidateCell(cellId);
  },

  setGlobalState: (updates: Partial<GlobalState>) => {
    set((state) => ({
      globalState: { ...state.globalState, ...updates }
    }));

    // é€šçŸ¥æ‰€æœ‰è®¢é˜…çš„å•å…ƒæ ¼
    // TODO: éœ€è¦ç»´æŠ¤è®¢é˜…åˆ—è¡¨
  }
}));

// æ¸²æŸ“å‡½æ•°ä½¿ç”¨ Storeï¼ˆé Hook æ–¹å¼ï¼‰
function renderNameCell(cellId: string, rowData: any): CDKElement {
  const state = cellStore.getState();
  const cellState = state.cellStates.get(cellId) || {};
  const globalState = state.globalState;

  const elements = [];

  elements.push(CDK.createText({
    text: rowData.name,
    onClick: () => state.setCellState(cellId, { textOn: true }),
    onHover: () => state.setCellState(cellId, { textOn: true }),
    onLeave: () => state.setCellState(cellId, { textOn: false })
  }));

  if (cellState.textOn) {
    elements.push(CDK.createIcon({ name: 'edit' }));
  }

  if (globalState.extraContext.last_comment) {
    elements.push(CDK.createComment({ data: globalState.extraContext.last_comment }));
  }

  return CDK.createRow({ children: elements });
}

// è®¢é˜…å…¨å±€çŠ¶æ€å˜åŒ–
cellStore.subscribe((state, prevState) => {
  if (state.globalState !== prevState.globalState) {
    // é‡æ¸²æŸ“æ‰€æœ‰ä¾èµ–å…¨å±€çŠ¶æ€çš„å•å…ƒæ ¼
    // TODO: éœ€è¦ä¼˜åŒ–ï¼ˆåªé‡æ¸²æŸ“çœŸæ­£ä¾èµ–çš„å•å…ƒæ ¼ï¼‰
  }
});
```

**ä¼˜åŠ¿**ï¼š

```
âœ… æ— éœ€è‡ªå»ºçŠ¶æ€ç®¡ç†ï¼ˆZustand æˆç†Ÿç¨³å®šï¼‰
âœ… Bundle æå°ï¼ˆ3KBï¼‰
âœ… API ç®€æ´ï¼ˆæ¯” Redux ç®€å•ï¼‰
âœ… æ€§èƒ½å¥½ï¼ˆé€‰æ‹©æ€§è®¢é˜…ï¼‰
âœ… å¯ä»¥è„±ç¦» React ä½¿ç”¨
```

**åŠ£åŠ¿**ï¼š

```
âŒ éœ€è¦æ‰‹åŠ¨ç®¡ç†è®¢é˜…ï¼ˆå…¨å±€çŠ¶æ€ â†’ å•å…ƒæ ¼ï¼‰
âŒ æ— æ³•è‡ªåŠ¨è¿½è¸ªä¾èµ–ï¼ˆéœ€è¦æ‰‹åŠ¨å£°æ˜ï¼‰
âŒ ä»éœ€å®ç°è®¢é˜…é€šçŸ¥æœºåˆ¶ï¼ˆ~100 è¡Œï¼‰
```

---

### 2.3 æ–¹æ¡ˆ 2.2ï¼šJotai Atoms

**Jotai ç‰¹ç‚¹**ï¼š

```
Bundle å¤§å°ï¼š~5KB
API é£æ ¼ï¼šåŸå­åŒ–çŠ¶æ€ï¼ˆRecoil-likeï¼‰
æ€§èƒ½ï¼šæè‡´ï¼ˆç»†ç²’åº¦è®¢é˜…ï¼‰
React ä¾èµ–ï¼šå¯é€‰
```

**ä»£ç ç¤ºä¾‹**ï¼š

```typescript
import { createStore, atom } from 'jotai/vanilla';

// åˆ›å»ºåŸå­åŒ–çŠ¶æ€
const cellStateAtom = (cellId: string) => atom({
  textOn: false,
  cellOn: false
});

const globalContextAtom = atom({
  extraContext: {},
  inTreeView: false
});

// åˆ›å»º Store
const store = createStore();

// æ¸²æŸ“å‡½æ•°
function renderNameCell(cellId: string, rowData: any): CDKElement {
  // è¯»å–åŸå­çŠ¶æ€
  const cellState = store.get(cellStateAtom(cellId));
  const globalContext = store.get(globalContextAtom);

  const elements = [];

  elements.push(CDK.createText({
    text: rowData.name,
    onClick: () => {
      // æ›´æ–°åŸå­çŠ¶æ€
      store.set(cellStateAtom(cellId), { ...cellState, textOn: true });

      // è§¦å‘é‡æ¸²æŸ“
      window.__RUST_ENGINE__.invalidateCell(cellId);
    }
  }));

  if (cellState.textOn) {
    elements.push(CDK.createIcon({ name: 'edit' }));
  }

  return CDK.createRow({ children: elements });
}

// è®¢é˜…å…¨å±€çŠ¶æ€
store.sub(globalContextAtom, () => {
  // é€šçŸ¥æ‰€æœ‰å•å…ƒæ ¼é‡æ¸²æŸ“
});
```

**ä¼˜åŠ¿**ï¼š

```
âœ… ç»†ç²’åº¦è®¢é˜…ï¼ˆæ€§èƒ½æœ€ä¼˜ï¼‰
âœ… åŸå­åŒ–çŠ¶æ€ï¼ˆè§£è€¦ï¼‰
âœ… å¯ç»„åˆï¼ˆæ´¾ç”ŸçŠ¶æ€ï¼‰
```

**åŠ£åŠ¿**ï¼š

```
âŒ æ¦‚å¿µç¨å¤æ‚ï¼ˆéœ€è¦å­¦ä¹  Atom æ¨¡å¼ï¼‰
âŒ ä»éœ€æ‰‹åŠ¨è§¦å‘é‡æ¸²æŸ“
```

---

## ç¬¬ä¸‰ç« ï¼šè·¯å¾„ 3 - è‡ªå»ºçŠ¶æ€ç®¡ç†

### 3.1 ä½•æ—¶å€¼å¾—è‡ªå»ºï¼Ÿ

**å€¼å¾—è‡ªå»ºçš„åœºæ™¯**ï¼š

```
æ¡ä»¶ 1ï¼šæœ‰ç‰¹æ®Šéœ€æ±‚ï¼ˆç°æœ‰åº“æ— æ³•æ»¡è¶³ï¼‰
â”œâ”€ éœ€è¦ä¸ Rust æ·±åº¦é›†æˆ
â”œâ”€ éœ€è¦ç‰¹å®šçš„è®¢é˜…æ¨¡å¼
â””â”€ éœ€è¦æè‡´æ€§èƒ½ä¼˜åŒ–

æ¡ä»¶ 2ï¼šå›¢é˜Ÿæœ‰èƒ½åŠ›å’Œæ—¶é—´
â”œâ”€ æœ‰å‰ç«¯æ¶æ„å¸ˆï¼ˆæ·±å…¥ç†è§£çŠ¶æ€ç®¡ç†ï¼‰
â”œâ”€ æœ‰ 6+ å‘¨æ—¶é—´æŠ•å…¥
â””â”€ æ„¿æ„é•¿æœŸç»´æŠ¤

æ¡ä»¶ 3ï¼šç°æœ‰åº“çš„æˆæœ¬ > è‡ªå»ºæˆæœ¬
â”œâ”€ ç°æœ‰åº“å¼•å…¥ä¸å¿…è¦çš„ä¾èµ–
â”œâ”€ ç°æœ‰åº“ Bundle è¿‡å¤§ï¼ˆä¸å¤ªå¯èƒ½ï¼ŒZustand åªæœ‰ 3KBï¼‰
â””â”€ ç°æœ‰åº“æ€§èƒ½ä¸æ»¡è¶³è¦æ±‚ï¼ˆæå°‘è§ï¼‰
```

**ä¸å€¼å¾—è‡ªå»ºçš„åœºæ™¯**ï¼š

```
âŒ åªæ˜¯ä¸ºäº†"é¿å…ä¾èµ–å¤–éƒ¨åº“"
âŒ åªæ˜¯ä¸ºäº†"å­¦ä¹ çŠ¶æ€ç®¡ç†åŸç†"ï¼ˆå¯ä»¥ï¼Œä½†ä¸åº”è¯¥ç”¨åœ¨ç”Ÿäº§ï¼‰
âŒ åªæ˜¯ä¸ºäº†"æ€§èƒ½ä¼˜åŒ–"ï¼ˆZustand/Jotai å·²ç»å¤Ÿå¿«ï¼‰
```

### 3.2 è‡ªå»ºçš„çœŸå®æˆæœ¬

**å¼€å‘æˆæœ¬**ï¼š

```
ç¬¬ 1-2 å‘¨ï¼šæ ¸å¿ƒå®ç°
â”œâ”€ useState å®ç°ï¼š~200 è¡Œ
â”œâ”€ useContext å®ç°ï¼š~200 è¡Œ
â”œâ”€ è®¢é˜…ç³»ç»Ÿï¼š~150 è¡Œ
â””â”€ é‡æ¸²æŸ“è°ƒåº¦ï¼š~100 è¡Œ

ç¬¬ 3-4 å‘¨ï¼šè¾¹ç•Œæƒ…å†µå¤„ç†
â”œâ”€ Hook è°ƒç”¨é¡ºåºæ£€æŸ¥ï¼š~100 è¡Œ
â”œâ”€ é˜²æ­¢æ— é™å¾ªç¯ï¼š~50 è¡Œ
â”œâ”€ æ‰¹é‡æ›´æ–°ä¼˜åŒ–ï¼š~100 è¡Œ
â””â”€ å†…å­˜æ³„æ¼æ£€æµ‹ï¼š~50 è¡Œ

ç¬¬ 5-6 å‘¨ï¼šæµ‹è¯•å’Œä¼˜åŒ–
â”œâ”€ å•å…ƒæµ‹è¯•ï¼š~500 è¡Œ
â”œâ”€ æ€§èƒ½æµ‹è¯•
â””â”€ Bug ä¿®å¤

æ€»è®¡ï¼š~1,550 è¡Œä»£ç ï¼Œ6 å‘¨å¼€å‘
```

**ç»´æŠ¤æˆæœ¬**ï¼š

```
æŒç»­æˆæœ¬ï¼š
â”œâ”€ å‘ç°æ–° bug â†’ ä¿®å¤ï¼ˆæŒç»­ï¼‰
â”œâ”€ æ€§èƒ½ä¼˜åŒ–ï¼ˆæŒç»­ï¼‰
â”œâ”€ æ–°åŠŸèƒ½éœ€æ±‚ â†’ è‡ªå·±å®ç°ï¼ˆå¦‚ useEffectï¼‰
â””â”€ å›¢é˜ŸåŸ¹è®­ï¼ˆæ–°äººéœ€è¦å­¦ä¹ è‡ªå»ºç³»ç»Ÿï¼‰
```

### 3.3 è‡ªå»º vs Zustand å¯¹æ¯”

| ç»´åº¦ | è‡ªå»º | Zustand |
|------|------|---------|
| **å¼€å‘æˆæœ¬** | 6 å‘¨ | 0ï¼ˆå®‰è£…å³ç”¨ï¼‰|
| **ä»£ç é‡** | ~1,550 è¡Œ | 0ï¼ˆä¾èµ–åº“ï¼‰|
| **Bundle** | 0ï¼ˆä»£ç åœ¨é¡¹ç›®ä¸­ï¼‰| +3KB |
| **ç»´æŠ¤æˆæœ¬** | é«˜ï¼ˆæŒç»­ï¼‰| 0ï¼ˆç¤¾åŒºç»´æŠ¤ï¼‰|
| **ç¨³å®šæ€§** | æœªçŸ¥ï¼ˆè‡ªå»ºï¼‰| é«˜ï¼ˆæˆç†Ÿåº“ï¼‰|
| **åŠŸèƒ½å®Œæ•´æ€§** | åŸºç¡€ | å®Œæ•´ |
| **æ€§èƒ½** | æœªä¼˜åŒ– | å·²ä¼˜åŒ– |

**ç»“è®º**ï¼š

```
é™¤éæœ‰ç‰¹æ®Šéœ€æ±‚ï¼ˆå¦‚ä¸ Rust æ·±åº¦é›†æˆï¼‰ï¼Œ
å¦åˆ™ä½¿ç”¨ Zustand çš„æˆæœ¬è¿œå°äºè‡ªå»ºã€‚

+3KB Bundle vs 6 å‘¨å¼€å‘æ—¶é—´
â†’ Zustand æ˜¯æ˜æ˜¾çš„èµ¢å®¶
```

---

## ç¬¬å››ç« ï¼šè·¯å¾„ 4 - ä¿ç•™ Reactï¼Œæ”¹ä¸ºå‘½ä»¤å¼ API

### 4.1 æ ¸å¿ƒæ€æƒ³

**å…³é”®æ´å¯Ÿ**ï¼šä¸æ”¾å¼ƒ Reactï¼Œåªæ”¹å˜è¿”å›å€¼é£æ ¼ã€‚

```typescript
// ä»ç„¶æ˜¯ React ç»„ä»¶
const RawNameInTableCanvas: React.FC = (props) => {
  // âœ… ä»ç„¶ä½¿ç”¨ React Hooks
  const [textOn, setTextOn] = useState(false);
  const extraContext = useTableStoreState('extraContext');

  // âŒ ä¸è¿”å› JSX
  // return <CDK.Row>...</CDK.Row>;

  // âœ… è¿”å›å‘½ä»¤å¼å¯¹è±¡
  return useMemo(() => {
    const elements = [];
    elements.push(CDK.createText({ text: props.data.name }));
    if (textOn) elements.push(CDK.createIcon({ name: 'edit' }));
    return CDK.createRow({ children: elements });
  }, [props.data.name, textOn]);
};
```

### 4.2 è¿™å°±æ˜¯ Preact çš„æ€è·¯

**å®é™…ä¸Šï¼Œè¿™ä¸ªæ–¹æ¡ˆæœ¬è´¨ä¸Šå°±æ˜¯**ï¼š

```
è·¯å¾„ 4ï¼ˆä¿ç•™ React Hooks + å‘½ä»¤å¼ APIï¼‰
= Preactï¼ˆè½»é‡çº§ Reactï¼‰
```

**å› ä¸º**ï¼š

```
1. Preact ä¹Ÿæ”¯æŒ React Hooks
2. Preact ä¹Ÿå¯ä»¥ç”¨ h() å‡½æ•°ï¼ˆå‘½ä»¤å¼ï¼‰
3. Preact åªæ˜¯æ›´è½»é‡çš„ Reactï¼ˆæ—  Fiberã€æ—  Schedulerï¼‰
```

**ç»“è®º**ï¼šè·¯å¾„ 4 ä¸æ˜¯ç‹¬ç«‹æ–¹æ¡ˆï¼Œè€Œæ˜¯ Preactã€‚

---

## ç¬¬äº”ç« ï¼šå››ç§è·¯å¾„çš„æœ€ç»ˆå¯¹æ¯”

### 5.1 ç»¼åˆå¯¹æ¯”è¡¨

| ç»´åº¦ | è·¯å¾„1ï¼ˆçº¯å‘½ä»¤å¼ï¼‰| è·¯å¾„2ï¼ˆZustandï¼‰| è·¯å¾„3ï¼ˆè‡ªå»ºï¼‰| è·¯å¾„4ï¼ˆPreactï¼‰|
|------|----------------|----------------|-------------|---------------|
| **çŠ¶æ€ç®¡ç†** | Rust/å…¨å±€Store | Zustand | è‡ªå»º | React/Preact Hooks |
| **å¼€å‘æˆæœ¬** | 2-3å‘¨ | 1-2å‘¨ | **6å‘¨** | 1å¤© |
| **ä»£ç é‡** | ~3,200è¡Œ | ~3,200è¡Œ | **~4,600è¡Œ** | 0ï¼ˆæ”¹é…ç½®ï¼‰|
| **Bundle** | 0 | +3KB | 0 | +5KBï¼ˆPreactï¼‰|
| **ç»´æŠ¤æˆæœ¬** | ä¸­ | **ä½** | **é«˜** | 0 |
| **æ€§èƒ½** | æè‡´ | ä¼˜ç§€ | æœªçŸ¥ | ä¼˜ç§€ |
| **API é£æ ¼** | çº¯å‡½æ•° | Store.get/set | ç±» Hooks | React Hooks |
| **å­¦ä¹ æˆæœ¬** | ä½ | ä½ | **é«˜**ï¼ˆè‡ªå»ºï¼‰| 0 |
| **ç¨³å®šæ€§** | é«˜ | **é«˜**ï¼ˆæˆç†Ÿåº“ï¼‰| **æœªçŸ¥** | é«˜ |
| **æ¨èåº¦** | â­â­â­â­ | â­â­â­â­â­ | â­â­ | â­â­â­â­â­ï¼ˆå¦‚æœå¯ä»¥ï¼‰|

---

### 5.2 å†³ç­–çŸ©é˜µ

```
ä½ çš„éœ€æ±‚ â†’ æ¨èè·¯å¾„

é—®ï¼šæ˜¯å¦éœ€è¦å¤æ‚çš„çŠ¶æ€ç®¡ç†ï¼Ÿ
â”œâ”€ å¦ï¼ˆçŠ¶æ€ç®€å•ï¼‰â†’ è·¯å¾„1ï¼ˆçº¯å‘½ä»¤å¼ï¼‰
â”‚   â”œâ”€ Rust ç®¡ç†çŠ¶æ€
â”‚   â””â”€ æ¸²æŸ“å‡½æ•°æ˜¯çº¯å‡½æ•°
â”‚
â””â”€ æ˜¯ï¼ˆçŠ¶æ€å¤æ‚ï¼‰â†’ é—®ï¼šæ•´ä¸ªé¡¹ç›®å¯ä»¥æ›¿æ¢å—ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ è·¯å¾„4ï¼ˆPreactï¼‰â­â­â­â­â­
    â”‚   â””â”€ 1å¤©å®Œæˆï¼Œæ€§èƒ½æå‡ 2.4å€
    â”‚
    â””â”€ å¦ â†’ é—®ï¼šæœ‰ç‰¹æ®Šéœ€æ±‚å—ï¼Ÿ
        â”œâ”€ æ˜¯ï¼ˆå¦‚ä¸ Rust æ·±åº¦é›†æˆï¼‰â†’ è·¯å¾„3ï¼ˆè‡ªå»ºï¼‰â­â­
        â”‚   â””â”€ 6å‘¨å¼€å‘ï¼Œéœ€è¦é•¿æœŸç»´æŠ¤
        â”‚
        â””â”€ å¦ â†’ è·¯å¾„2ï¼ˆZustandï¼‰â­â­â­â­â­
            â””â”€ 1-2å‘¨å®Œæˆï¼Œæˆç†Ÿç¨³å®š
```

---

## ç¬¬å…­ç« ï¼šå›ç­”ä½ çš„æ ¸å¿ƒé—®é¢˜

### é—®ï¼š"å‘½ä»¤å¼+åŸºç¡€ç»„ä»¶æ”¹é€ ï¼Œä¸€å®šè¦è‡ªå·±å®ç° React åŠŸèƒ½å—ï¼Ÿ"

**ç­”ï¼šä¸ä¸€å®šï¼å–å†³äºä½ çš„çŠ¶æ€ç®¡ç†éœ€æ±‚ã€‚**

#### **æƒ…å†µ 1ï¼šçŠ¶æ€ç®€å•ï¼ˆåªæœ‰æœ¬åœ°çŠ¶æ€ï¼‰**

```typescript
// âœ… è·¯å¾„1ï¼šçº¯å‘½ä»¤å¼ï¼ˆæ— éœ€çŠ¶æ€ç®¡ç†åº“ï¼‰
function renderNameCell(cellId: string, rowData: any, cellState: CellState): CDKElement {
  // çŠ¶æ€ç”± Rust æˆ–å¤–éƒ¨ä¼ å…¥
  const elements = [];
  elements.push(CDK.createText({ text: rowData.name }));
  if (cellState.textOn) {
    elements.push(CDK.createIcon({ name: 'edit' }));
  }
  return CDK.createRow({ children: elements });
}

// æ— éœ€è‡ªå»ºçŠ¶æ€ç®¡ç† âœ…
```

---

#### **æƒ…å†µ 2ï¼šçŠ¶æ€å¤æ‚ï¼ˆæœ‰å…¨å±€çŠ¶æ€ã€è®¢é˜…ï¼‰**

```typescript
// âœ… è·¯å¾„2ï¼šä½¿ç”¨ Zustandï¼ˆæ— éœ€è‡ªå»ºï¼‰
import create from 'zustand/vanilla';

const store = create((set) => ({
  cellStates: new Map(),
  setCellState: (cellId, updates) => { ... }
}));

function renderNameCell(cellId: string, rowData: any): CDKElement {
  const state = store.getState();
  const cellState = state.cellStates.get(cellId) || {};

  const elements = [];
  elements.push(CDK.createText({
    text: rowData.name,
    onClick: () => state.setCellState(cellId, { textOn: true })
  }));

  if (cellState.textOn) {
    elements.push(CDK.createIcon({ name: 'edit' }));
  }

  return CDK.createRow({ children: elements });
}

// æ— éœ€è‡ªå»ºçŠ¶æ€ç®¡ç† âœ…
// åªå¼•å…¥ Zustandï¼ˆ3KBï¼‰
```

---

#### **æƒ…å†µ 3ï¼šæœ‰ç‰¹æ®Šéœ€æ±‚ï¼ˆZustand æ— æ³•æ»¡è¶³ï¼‰**

```typescript
// âš ï¸ è·¯å¾„3ï¼šè‡ªå»ºçŠ¶æ€ç®¡ç†ï¼ˆå°‘è§ï¼‰

// ç‰¹æ®Šéœ€æ±‚ç¤ºä¾‹ï¼š
// 1. éœ€è¦ä¸ Rust æ·±åº¦é›†æˆï¼ˆçŠ¶æ€åœ¨ Rust ä¾§ï¼Œä½†éœ€è¦ Hooks APIï¼‰
// 2. éœ€è¦ç‰¹å®šçš„è®¢é˜…æ¨¡å¼ï¼ˆå¦‚æŒ‰å•å…ƒæ ¼ä½ç½®è®¢é˜…ï¼‰
// 3. éœ€è¦æè‡´æ€§èƒ½ä¼˜åŒ–ï¼ˆZustand å·²ç»å¤Ÿå¿«ï¼Œæå°‘éœ€è¦ï¼‰

class CustomStateManager {
  // è‡ªå®šä¹‰å®ç°...
}

// è¿™ç§æƒ…å†µæ‰å€¼å¾—è‡ªå»º âœ…
// ä½†éœ€è¦ 6 å‘¨å¼€å‘ + é•¿æœŸç»´æŠ¤
```

---

### é—®ï¼š"å¦‚æœä¸€å®šè¦è‡ªå»ºï¼Œé‡å¤é€ è½®å­ä¹Ÿæ²¡é‚£ä¹ˆå·®ï¼Ÿ"

**ç­”ï¼šå–å†³äº"ç‰¹æ®Šéœ€æ±‚"æ˜¯å¦çœŸå®å­˜åœ¨ã€‚**

#### **å€¼å¾—è‡ªå»ºçš„æƒ…å†µï¼ˆå°‘è§ï¼‰**ï¼š

```
åœºæ™¯ï¼šéœ€è¦ä¸ Rust æ·±åº¦é›†æˆ

éœ€æ±‚ï¼š
â”œâ”€ çŠ¶æ€å­˜å‚¨åœ¨ Rust ä¾§ï¼ˆè€Œé JavaScriptï¼‰
â”œâ”€ ä½†ä¸šåŠ¡é€»è¾‘éœ€è¦ç±» Hooks API
â”œâ”€ Zustand/Jotai æ— æ³•æ»¡è¶³ï¼ˆå®ƒä»¬æ˜¯çº¯ JSï¼‰
â””â”€ éœ€è¦è‡ªå®šä¹‰çš„è®¢é˜…æ¨¡å¼ï¼ˆæŒ‰å•å…ƒæ ¼ä½ç½®ï¼‰

è¿™ç§æƒ…å†µä¸‹ï¼š
â”œâ”€ è‡ªå»ºæ˜¯å¿…è¦çš„ï¼ˆZustand æ— æ³•æ»¡è¶³ï¼‰
â”œâ”€ 6 å‘¨æŠ•å…¥æ˜¯å€¼å¾—çš„
â””â”€ é•¿æœŸç»´æŠ¤æˆæœ¬æ˜¯å¯æ¥å—çš„
```

---

#### **ä¸å€¼å¾—è‡ªå»ºçš„æƒ…å†µï¼ˆå¸¸è§ï¼‰**ï¼š

```
è¯¯åŒºï¼š"æˆ‘æƒ³è¦å‘½ä»¤å¼ APIï¼Œæ‰€ä»¥è¦è‡ªå»ºçŠ¶æ€ç®¡ç†"

çœŸç›¸ï¼š
â”œâ”€ å‘½ä»¤å¼ API â‰  å¿…é¡»è‡ªå»ºçŠ¶æ€ç®¡ç†
â”œâ”€ Zustand æä¾› store.getState()ï¼ˆå‘½ä»¤å¼ï¼‰
â”œâ”€ æ— éœ€è‡ªå»º useState/useContext
â””â”€ 3KB Bundle vs 6 å‘¨å¼€å‘æ—¶é—´

ç»“è®ºï¼š
â””â”€ ä½¿ç”¨ Zustandï¼Œæ— éœ€è‡ªå»º âœ…
```

---

## æ€»ç»“

### ğŸ¯ æ ¸å¿ƒæ´å¯Ÿ

**1. "å‘½ä»¤å¼æ¸²æŸ“"æœ‰å¤šç§å®ç°è·¯å¾„**

```
è·¯å¾„ 1ï¼šçº¯å‘½ä»¤å¼ï¼ˆçŠ¶æ€ç”±å¤–éƒ¨ç®¡ç†ï¼‰
â”œâ”€ æ— éœ€çŠ¶æ€ç®¡ç†åº“
â”œâ”€ æ¸²æŸ“å‡½æ•°æ˜¯çº¯å‡½æ•°
â””â”€ é€‚ç”¨ï¼šçŠ¶æ€ç®€å•

è·¯å¾„ 2ï¼šZustand/Jotaiï¼ˆæˆç†Ÿåº“ï¼‰
â”œâ”€ æ— éœ€è‡ªå»ºçŠ¶æ€ç®¡ç†
â”œâ”€ 3-5KB Bundle
â””â”€ é€‚ç”¨ï¼šçŠ¶æ€å¤æ‚ï¼Œæ— ç‰¹æ®Šéœ€æ±‚ â­â­â­â­â­

è·¯å¾„ 3ï¼šè‡ªå»ºçŠ¶æ€ç®¡ç†
â”œâ”€ 6 å‘¨å¼€å‘
â”œâ”€ é•¿æœŸç»´æŠ¤
â””â”€ é€‚ç”¨ï¼šæœ‰ç‰¹æ®Šéœ€æ±‚ï¼ˆå°‘è§ï¼‰

è·¯å¾„ 4ï¼šPreact
â”œâ”€ 1 å¤©å®Œæˆ
â”œâ”€ 5KB Bundle
â””â”€ é€‚ç”¨ï¼šæ•´ä¸ªé¡¹ç›®å¯æ›¿æ¢ â­â­â­â­â­
```

---

**2. "è‡ªå»ºçŠ¶æ€ç®¡ç†"ä¸æ˜¯å”¯ä¸€é€‰æ‹©**

```
æˆ‘ä¹‹å‰çš„é”™è¯¯å‡è®¾ï¼š
"å‘½ä»¤å¼ + åŸºç¡€ç»„ä»¶æ”¹é€ " = å¿…é¡»è‡ªå»ºçŠ¶æ€ç®¡ç†

æ­£ç¡®ç†è§£ï¼š
"å‘½ä»¤å¼æ¸²æŸ“" â‰  å¿…é¡»è‡ªå»ºçŠ¶æ€ç®¡ç†
â”œâ”€ å¯ä»¥ç”¨ Zustandï¼ˆ3KBï¼Œæˆç†Ÿç¨³å®šï¼‰
â”œâ”€ å¯ä»¥çº¯å‘½ä»¤å¼ï¼ˆçŠ¶æ€ç”± Rust ç®¡ç†ï¼‰
â””â”€ åªæœ‰ç‰¹æ®Šéœ€æ±‚æ—¶æ‰éœ€è¦è‡ªå»º
```

---

**3. ä½•æ—¶å€¼å¾—è‡ªå»ºï¼Ÿ**

```
å€¼å¾—è‡ªå»ºçš„æ¡ä»¶ï¼ˆåŒæ—¶æ»¡è¶³ï¼‰ï¼š
â”œâ”€ æœ‰ç‰¹æ®Šéœ€æ±‚ï¼ˆZustand æ— æ³•æ»¡è¶³ï¼‰
â”œâ”€ å›¢é˜Ÿæœ‰èƒ½åŠ›å’Œæ—¶é—´ï¼ˆ6 å‘¨ï¼‰
â”œâ”€ æ„¿æ„é•¿æœŸç»´æŠ¤
â””â”€ è‡ªå»ºæˆæœ¬ < ä½¿ç”¨ç°æœ‰åº“æˆæœ¬

å®é™…æƒ…å†µï¼š
â””â”€ 95% çš„æƒ…å†µä¸‹ï¼ŒZustand è¶³å¤Ÿ âœ…
   åªæœ‰ 5% çš„æç«¯æƒ…å†µæ‰éœ€è¦è‡ªå»º
```

---

### ğŸ’¡ ä¸€å¥è¯æ€»ç»“

> **"å‘½ä»¤å¼+åŸºç¡€ç»„ä»¶æ”¹é€ "ä¸ä¸€å®šè¦è‡ªå·±å®ç° React åŠŸèƒ½ã€‚å¦‚æœçŠ¶æ€ç®€å•ï¼Œç”¨çº¯å‘½ä»¤å¼ï¼ˆçŠ¶æ€ç”± Rust ç®¡ç†ï¼‰ï¼›å¦‚æœçŠ¶æ€å¤æ‚ï¼Œç”¨ Zustandï¼ˆ3KBï¼Œæˆç†Ÿç¨³å®šï¼‰ï¼›åªæœ‰åœ¨ç‰¹æ®Šéœ€æ±‚ä¸‹ï¼ˆå¦‚ä¸ Rust æ·±åº¦é›†æˆï¼‰ï¼Œæ‰å€¼å¾—è‡ªå»ºçŠ¶æ€ç®¡ç†ï¼ˆ6 å‘¨å¼€å‘ + é•¿æœŸç»´æŠ¤ï¼‰ã€‚95% çš„æƒ…å†µä¸‹ï¼ŒZustand æ˜¯æœ€ä¼˜è§£ã€‚** ğŸš€

---

### ğŸ“Š æœ€ç»ˆæ¨è

**é’ˆå¯¹ä½ çš„é¡¹ç›®**ï¼š

```
æ¨èæ–¹æ¡ˆä¼˜å…ˆçº§ï¼š

ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šReact è‡ªèº«ä¼˜åŒ– â­â­â­â­â­
â”œâ”€ useMemo + ç¼“å­˜æ‰©å¤§ + Web Worker
â”œâ”€ 1-2 å‘¨ï¼Œ1.6 å€æå‡
â””â”€ é›¶ç»´æŠ¤æˆæœ¬

ç¬¬äºŒä¼˜å…ˆçº§ï¼šè·¯å¾„2ï¼ˆZustand + å‘½ä»¤å¼ï¼‰â­â­â­â­
â”œâ”€ å¦‚æœæ€§èƒ½ä»æ˜¯ç“¶é¢ˆ
â”œâ”€ 2-3 å‘¨ï¼Œ3 å€æå‡
â”œâ”€ +3KB Bundle
â””â”€ æ— éœ€è‡ªå»ºçŠ¶æ€ç®¡ç†

ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼šè·¯å¾„1ï¼ˆçº¯å‘½ä»¤å¼ï¼‰â­â­â­
â”œâ”€ å¦‚æœæ„¿æ„æ·±åº¦æ”¹é€ 
â”œâ”€ çŠ¶æ€ç”± Rust ç®¡ç†
â””â”€ æ— é¢å¤–ä¾èµ–

ä¸æ¨èï¼šè·¯å¾„3ï¼ˆè‡ªå»ºçŠ¶æ€ç®¡ç†ï¼‰
â””â”€ é™¤éæœ‰ç‰¹æ®Šéœ€æ±‚ï¼ˆæå°‘è§ï¼‰
```

---

> å†™ä½œæ—¥æœŸï¼š2024å¹´2æœˆ
> å­—æ•°ç»Ÿè®¡ï¼šçº¦7,000å­—
> æŠ€æœ¯æ·±åº¦ï¼šâ­â­â­â­â­ï¼ˆææ·±ï¼‰
> é€‚åˆè¯»è€…ï¼šéœ€è¦æ·±å…¥ç†è§£å‘½ä»¤å¼æ¸²æŸ“å¤šç§å®ç°è·¯å¾„çš„å‰ç«¯æ¶æ„å¸ˆ

[PROTOCOL]: å˜æ›´æ—¶æ›´æ–°æ­¤å¤´éƒ¨ï¼Œç„¶åæ£€æŸ¥ CLAUDE.md
