<!--
- [INPUT]: 幂等性设计、RSA/AES 加密、MutationObserver、Web Crypto
- [OUTPUT]: 前端纵深防御体系与稳定性兜底方案
- [POS]: 编程题/ 模块的核心专题，构建企业级应用的安全底座
- [PROTOCOL]: 变更时更新此头部，然后检查 CLAUDE.md
-->

# 2.6 安全与稳定性场景深度剖析

前端是应用安全的最前沿，也是最脆弱的一环。**安全与稳定性的本质是：不信任任何外部输入（包括用户点击），并通过“纵深防御（Defense in Depth）”与“自愈机制”将风险控制在可控范围内。**

---

### 2.6.1 防重复提交 (Anti-Double-Submission) ⭐⭐⭐

**现象**：用户快速点击按钮导致产生重复订单或脏数据。
**本质**：**全链路幂等性设计。**

#### 纵深防御层次
1.  **UI 层 (Visual Lock)**：点击后立即置灰按钮并显示 Loading，解决 90% 的物理重复触发。
2.  **请求层 (Traffic Control)**：利用请求 ID 锁。在当前请求未返回前，忽略后续相同参数的请求。
3.  **服务端 (Idempotent Key)**：由前端生成 UUID 作为幂等键随请求发送，服务端通过 Redis 缓存该键并拒绝重复操作。

---

### 2.6.2 前端加密传输 (Frontend Encryption) ⭐⭐⭐

**现象**：敏感信息（密码、密钥）在 HTTPS 之外需要额外的保障。
**本质**：非对称加密保护对称密钥。

#### 工业级加密流程
*   **混合加密**：
    1.  前端随机生成一个 **AES 密钥**（对称加密，效率高）。
    2.  用服务端的 **RSA 公钥** 加密这个 AES 密钥。
    3.  用 AES 密钥加密原始数据包。
    4.  发送加密后的 AES 密钥 + 加密后的数据包。
*   **优势**：既保证了大量数据传输的性能，又利用非对称加密解决了密钥分发安全。

---

### 2.6.3 水印方案与防删除机制 ⭐⭐⭐

**现象**：内部数据展示页面需要防截图追溯。
**本质**：**不可移除的视觉层叠加。**

#### 实现方式与攻防
| 方式 | 优点 | 缺点 | 场景 |
| :--- | :--- | :--- | :--- |
| **Canvas/SVG** | 灵活、支持动态内容 | DOM 节点可直接删除 | 通用场景 |
| **CSS 背景水印** | 性能最佳，不易选中 | 无法承载动态安全信息 | 轻量级防盗 |
| **暗水印 (LSD)** | 人眼不可见，截图后可解析 | 算法复杂，性能损耗 | 极高安全级别 |

**防删除机制**：
利用 `MutationObserver` 监听水印容器及其父节点。一旦发现水印节点被 `remove`、`hide` 或样式被篡改，立即在微任务队列中**重新渲染（Re-render）**水印，并触发安全预警上报。

---

## 哲学启示

安全是一场 **“成本不对称”** 的博弈。前端安全的目标不是绝对无法破解，而是将攻击者的成本（时间、精力、技术门槛）提高到超过获利价值的程度。
