<!--
- [INPUT]: Node.js Runtime, HTTP/2, SSR Engines (React/Vue), Hydration Mechanisms
- [OUTPUT]: BFF 层架构设计、同构渲染方案及服务端优化要求
- [POS]: 编程题/ 复杂场景专题，聚焦服务端能力支撑与前端架构纵向延伸
- [PROTOCOL]: 变更时更新此头部，然后检查 CLAUDE.md
-->

# 3.9 Node.js / BFF

在"前后端分离"向"全栈交付"进化的过程中，Node.js 承载的 BFF 层已成为提升前端响应灵活性与渲染性能的核心基础设施。

---

### 3.9.1 BFF 层架构设计 ⭐⭐⭐

**要求：** 设计一个支撑高性能业务交付的 BFF 服务框架。

- **职责挑战：**
  - **接口聚合 (Orchestration)**：实现面向前端 UI 的多异构微服务接口聚合，减少首屏请求数。
  - **数据缓存与清洗**：实现服务端级的高速缓存（Redis）与字段格式转换。
  - **错误降级 (Fallback)**：设计当后端核心接口挂掉时的容错处理与兜底方案。
  - **全链路追踪**：在 Node 侧集成 TraceID，打通前后端系统的监控指标。

---

### 3.9.2 SSR 同构渲染方案 ⭐⭐⭐⭐

**要求：** 深入理解 Web 同构渲染的生命周期，并具备处理各种边缘情况的能力。

- **核心流程：**
  - **数据预取 (Data Fetching)**：在服务端精准获取首屏数据，并解决客户端无需二次获取的问题。
  - **Hydration (注水) 算法**：客户端如何正确地为静态 HTML 激活交互逻辑，并处理 DOM 结构不匹配 (Mismatch)。
  - **流式渲染 (Streaming Rendering)**：利用 HTTP 分块传输，极速首屏呈现与后续块动态载入。
  - **性能优化与缓存**：服务端页面片段缓存 (Fragment Cache) 与静态化策略。
  - **降级方案 (CSR Fallback)**：当服务端渲染压力过大或报错时，自动降级为纯客户端渲染的机制。

---

### 3.9.3 Serverless 应用与优化 ⭐⭐⭐

**要求：** 基于 FaaS 模式部署逻辑，关注运维成本与启动性能。

- **优化重点：**
  - **冷启动 (Cold Start)**：优化包体积、Tree-shaking 及并发调用策略。
  - **函数拆分颗粒度**：单一职责函数的设计与协作模式。
  - **无状态设计 (Stateless)**：如何在计算层与持久层（数据库/缓存）间建立稳定的状态映射。

---

## 质量指标

- **稳定性 (QPS)**：Node 服务在高并发请求下的负载波动。
- **TTFB (Time To First Byte)**：SSR 模式下服务端响应的首字节时长。
- **可维护性**：同构代码在 Node 端与浏览器端的共享程度与测试覆盖率。
