<!--
- [INPUT]: WebSocket åè®®ã€å¿ƒè·³ä¿æ´»ã€æŒ‡æ•°é€€é¿é‡è¿ã€æ¶ˆæ¯å¹‚ç­‰
- [OUTPUT]: é«˜å¯ç”¨ã€å¼ºå¯é çš„å®æ—¶é€šä¿¡ç³»ç»Ÿå‰ç«¯å®ç°è§„èŒƒ
- [POS]: ç¼–ç¨‹é¢˜/ æ¨¡å—çš„æ ¸å¿ƒä¸“é¢˜ï¼Œè§£å†³å®æ—¶æ•°æ®çš„ä¸€è‡´æ€§ä¸ç¨³å®šæ€§
- [PROTOCOL]: å˜æ›´æ—¶æ›´æ–°æ­¤å¤´éƒ¨ï¼Œç„¶åæ£€æŸ¥ CLAUDE.md
-->

# 2.5 å®æ—¶é€šä¿¡åœºæ™¯æ·±åº¦å‰–æ

å®æ—¶é€šä¿¡ï¼ˆReal-time Communicationï¼‰çš„æ ¸å¿ƒæŒ‘æˆ˜åœ¨äºç½‘ç»œçŠ¶æ€çš„ä¸å¯æµ‹æ€§ã€‚**å®æ—¶é€šä¿¡çš„æœ¬è´¨æ˜¯ï¼šåœ¨ä¸€ä¸ªä¸å¯é çš„é•¿è¿æ¥ä¸Šï¼Œé€šè¿‡"ç¡®è®¤æœºåˆ¶ï¼ˆACKï¼‰"ä¸"çŠ¶æ€è‡ªæ„ˆï¼ˆRecoveryï¼‰"æ¥æ¨¡æ‹Ÿä¸€ä¸ªç¡®å®šæ€§çš„åŒå‘åŒæ­¥é€šé“ã€‚**

---

### 2.5.1 WebSocket é“¾æ¥ç¨³å®šæ€§ç®¡ç† â­â­â­

**ç°è±¡**ï¼šWebSocket ä¼šå› ç½‘ç»œåˆ‡æ¢ã€é”å±ã€è¿è¥å•†æ¸…ç†ç­‰åŸå› åœ¨æ— æ„ŸçŸ¥çš„æƒ…å†µä¸‹æ–­å¼€ã€‚
**æœ¬è´¨**ï¼šå»ºç«‹ **åº”ç”¨å±‚æ¢æ´»æœºåˆ¶**ã€‚

#### æ ¸å¿ƒæ²»ç†æ–¹æ¡ˆ

1.  **å¿ƒè·³ä¿æ´» (Heartbeat)**ï¼šå®šæ—¶å‘é€ `Ping` åŒ…ã€‚è‹¥åœ¨è§„å®šæ—¶é—´å†…æœªæ”¶åˆ° `Pong`ï¼Œä¸»åŠ¨åˆ¤å®šè¿æ¥å·²æ–­å¼€å¹¶æ‰§è¡Œé‡è¿ã€‚
2.  **æŒ‡æ•°é€€é¿é‡è¿ (Exponential Backoff)**ï¼šé‡è¿æ—¶é—´é—´éš”åº”æŒ‰ `1s, 2s, 4s, 8s...` å¢åŠ ï¼Œå¹¶åŠ å…¥éšæœºæ‰°åŠ¨ï¼ˆJitterï¼‰ï¼Œé˜²æ­¢æœåŠ¡å™¨å› å¤§é‡å®¢æˆ·ç«¯åŒæ—¶é‡è¿è€Œå´©æºƒã€‚
3.  **å¤šå®ä¾‹å±è”½**ï¼šå•ä¾‹æ¨¡å¼å°è£…ï¼Œé˜²æ­¢é¡µé¢å¼€å¯å¤šä¸ªé•¿è¿æ¥ã€‚

#### å®Œæ•´å®ç°

```typescript
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  RobustWebSocket â€” å¿ƒè·³ + æŒ‡æ•°é€€é¿ + å•ä¾‹
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

type WSEvent = "open" | "close" | "message" | "error";
type WSHandler = (data?: any) => void;

interface RobustWSOptions {
  url: string;
  heartbeatInterval?: number; // å¿ƒè·³é—´éš” msï¼Œé»˜è®¤ 30s
  heartbeatTimeout?: number; // Pong è¶…æ—¶ msï¼Œé»˜è®¤ 5s
  maxReconnectDelay?: number; // æœ€å¤§é‡è¿é—´éš” msï¼Œé»˜è®¤ 60s
  maxRetries?: number; // æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤ Infinity
}

class RobustWebSocket {
  // â”€â”€ å•ä¾‹å®ˆå« â”€â”€
  private static instance: RobustWebSocket | null = null;
  static getInstance(opts: RobustWSOptions): RobustWebSocket {
    if (!RobustWebSocket.instance) {
      RobustWebSocket.instance = new RobustWebSocket(opts);
    }
    return RobustWebSocket.instance;
  }

  private ws: WebSocket | null = null;
  private opts: Required<RobustWSOptions>;
  private retryCount = 0;
  private heartbeatTimer: number | null = null;
  private pongTimer: number | null = null;
  private listeners = new Map<WSEvent, Set<WSHandler>>();
  private disposed = false;

  private constructor(opts: RobustWSOptions) {
    this.opts = {
      heartbeatInterval: 30_000,
      heartbeatTimeout: 5_000,
      maxReconnectDelay: 60_000,
      maxRetries: Infinity,
      ...opts,
    };
    this.connect();
  }

  // â”€â”€ è¿æ¥ â”€â”€
  private connect(): void {
    if (this.disposed) return;
    this.ws = new WebSocket(this.opts.url);

    this.ws.onopen = () => {
      this.retryCount = 0; // è¿æ¥æˆåŠŸï¼Œé‡ç½®è®¡æ•°å™¨
      this.startHeartbeat();
      this.emit("open");
    };

    this.ws.onmessage = (e) => {
      if (e.data === "pong") {
        this.clearPongTimer(); // æ”¶åˆ° Pongï¼Œåœæ­¢è¶…æ—¶è®¡æ—¶
        return;
      }
      this.emit("message", JSON.parse(e.data));
    };

    this.ws.onclose = () => {
      this.stopHeartbeat();
      this.emit("close");
      this.reconnect(); // æ–­å¼€å³é‡è¿
    };

    this.ws.onerror = () => this.emit("error");
  }

  // â”€â”€ å¿ƒè·³ä¿æ´» â”€â”€
  private startHeartbeat(): void {
    this.heartbeatTimer = window.setInterval(() => {
      if (this.ws?.readyState === WebSocket.OPEN) {
        this.ws.send("ping");
        // å¯åŠ¨ Pong è¶…æ—¶æ£€æµ‹
        this.pongTimer = window.setTimeout(() => {
          this.ws?.close(); // è¶…æ—¶ â†’ è§†ä¸ºæ­»è¿æ¥
        }, this.opts.heartbeatTimeout);
      }
    }, this.opts.heartbeatInterval);
  }

  private stopHeartbeat(): void {
    if (this.heartbeatTimer) clearInterval(this.heartbeatTimer);
    this.clearPongTimer();
  }

  private clearPongTimer(): void {
    if (this.pongTimer) {
      clearTimeout(this.pongTimer);
      this.pongTimer = null;
    }
  }

  // â”€â”€ æŒ‡æ•°é€€é¿é‡è¿ï¼ˆå« Jitterï¼‰ â”€â”€
  private reconnect(): void {
    if (this.disposed || this.retryCount >= this.opts.maxRetries) return;

    const base = Math.min(
      1000 * Math.pow(2, this.retryCount), // 1s, 2s, 4s, 8s ...
      this.opts.maxReconnectDelay,
    );
    // Jitter: åœ¨ [base/2, base] ä¹‹é—´éšæœºï¼Œé¿å…"æƒŠç¾¤æ•ˆåº”"
    const jitter = base / 2 + Math.random() * (base / 2);

    this.retryCount++;
    console.log(
      `[WS] å°†åœ¨ ${Math.round(jitter)}ms åç¬¬ ${this.retryCount} æ¬¡é‡è¿`,
    );
    setTimeout(() => this.connect(), jitter);
  }

  // â”€â”€ äº‹ä»¶æ€»çº¿ â”€â”€
  on(event: WSEvent, handler: WSHandler): void {
    if (!this.listeners.has(event)) this.listeners.set(event, new Set());
    this.listeners.get(event)!.add(handler);
  }

  private emit(event: WSEvent, data?: any): void {
    this.listeners.get(event)?.forEach((fn) => fn(data));
  }

  send(data: unknown): void {
    if (this.ws?.readyState === WebSocket.OPEN) {
      this.ws.send(JSON.stringify(data));
    }
  }

  dispose(): void {
    this.disposed = true;
    this.stopHeartbeat();
    this.ws?.close();
    RobustWebSocket.instance = null;
  }
}
```

**æ¶æ„è§£è¯»**ï¼š

| æœºåˆ¶            | ä½œç”¨         | å¯¹æŠ—çš„å¤±æ•ˆæ¨¡å¼                         |
| --------------- | ------------ | -------------------------------------- |
| å¿ƒè·³ Ping/Pong  | åº”ç”¨å±‚æ¢æ´»   | TCP åŠå¼€è¿æ¥ï¼ˆå¯¹ç«¯å´©æºƒã€NAT è¶…æ—¶ï¼‰     |
| æŒ‡æ•°é€€é¿        | æ¸è¿›å¼é‡è¿   | ç¬æ—¶å¤§é‡å®¢æˆ·ç«¯åŒæ—¶é‡è¿å¯¼è‡´çš„"æƒŠç¾¤æ•ˆåº”" |
| Jitter éšæœºæ‰°åŠ¨ | æ‰“æ•£é‡è¿æ—¶é—´ | é€€é¿å…¬å¼ç›¸åŒå¯¼è‡´çš„é‡è¿æµªæ½®             |
| å•ä¾‹æ¨¡å¼        | å…¨å±€ä¸€ä¸ªè¿æ¥ | å¤š Tab/ç»„ä»¶å„è‡ªåˆ›å»ºè¿æ¥å¯¼è‡´èµ„æºè€—å°½    |

> **è®¾è®¡å“²å­¦**ï¼šå¿ƒè·³ä¸æ˜¯"ä¿æŒè¿æ¥"ï¼Œè€Œæ˜¯"ä¸»åŠ¨å‘ç°æ­»äº¡"ã€‚ä½ æ— æ³•è®©ä¸€æ¡æ³¨å®šæ–­å¼€çš„è¿æ¥ä¸æ–­å¼€ï¼Œä½†ä½ å¯ä»¥åœ¨å®ƒæ–­å¼€çš„ç¬é—´å°±çŸ¥é“ã€‚

---

### 2.5.2 æ¶ˆæ¯å¯é æ€§ä¿è¯ (Message Reliability) â­â­â­

**åœºæ™¯**ï¼šIM æ¶ˆæ¯å¿…é¡»åšåˆ°"ä¸ä¸¢ã€ä¸é‡ã€ä¸ä¹±åº"ã€‚
**æœ¬è´¨**ï¼šå¼•å…¥ **ç‰ˆæœ¬å·ï¼ˆSequenceï¼‰ä¸å›æ‰§ï¼ˆACKï¼‰** ç³»ç»Ÿã€‚

#### å…³é”®æŠ€æœ¯å®ç°

- **å»é‡ (Deduplication)**ï¼šæ¯æ¡æ¶ˆæ¯æºå¸¦å®¢æˆ·ç«¯ç”Ÿæˆçš„å”¯ä¸€ `msgId`ã€‚æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯å‡ç»´æŠ¤è¿‘æœŸæ¶ˆæ¯ ID ç¼“å­˜ï¼Œä¸¢å¼ƒé‡å¤æ¶ˆæ¯ã€‚
- **æ’åº (Ordering)**ï¼šåŸºäºæœåŠ¡ç«¯è¿”å›çš„å•è°ƒé€’å¢åºåˆ—å·ï¼ˆSeqï¼‰è¿›è¡Œ UI æ’åºï¼Œè§£å†³ç½‘ç»œä¹±åºå¯¼è‡´çš„å¯¹è¯é”™ä¹±ã€‚
- **æ¶ˆæ¯ ACK ä¸è¡¥å‘**ï¼šå®¢æˆ·ç«¯å‘é€æ¶ˆæ¯åè¿›å…¥ `Pending` çŠ¶æ€ï¼Œè‹¥åœ¨è¶…æ—¶æ—¶é—´å†…æœªæ”¶åˆ°æœåŠ¡ç«¯çš„ ACK ç¡®è®¤ï¼Œåˆ™è§¦å‘é‡å‘æœºåˆ¶ã€‚
- **ç¦»çº¿æ‹‰å– (Sync)**ï¼šè¿æ¥é‡è¿åï¼Œæºå¸¦æœ¬åœ°æœ€é«˜ Seq å‘æœåŠ¡ç«¯æ‹‰å–æ–­çº¿æœŸé—´çš„å·®å¼‚æ¶ˆæ¯ã€‚

#### å®Œæ•´å®ç°

```typescript
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ReliableMessageChannel â€” ACK + å»é‡ + æ’åº + ç¦»çº¿åŒæ­¥
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

interface Message {
  msgId: string; // å®¢æˆ·ç«¯ç”Ÿæˆçš„å”¯ä¸€ IDï¼ˆUUIDï¼‰
  seq?: number; // æœåŠ¡ç«¯åˆ†é…çš„å•è°ƒé€’å¢åºåˆ—å·
  content: string;
  timestamp: number;
  status: "pending" | "sent" | "acked" | "failed";
}

interface ServerACK {
  type: "ack";
  msgId: string;
  seq: number;
}

interface ServerMessage {
  type: "message";
  msgId: string;
  seq: number;
  content: string;
  timestamp: number;
}

class ReliableMessageChannel {
  private ws: RobustWebSocket;
  private pendingMessages = new Map<
    string,
    { msg: Message; timer: number; retries: number }
  >();
  private messageCache = new Set<string>(); // è¿‘æœŸæ¶ˆæ¯ ID ç¼“å­˜ï¼ˆå»é‡ï¼‰
  private localMaxSeq = 0; // æœ¬åœ°æœ€é«˜ Seq
  private messageList: Message[] = []; // æœ‰åºæ¶ˆæ¯åˆ—è¡¨
  private onUpdate: (messages: Message[]) => void;

  private readonly ACK_TIMEOUT = 5_000;
  private readonly MAX_RETRIES = 3;
  private readonly CACHE_SIZE = 1000;

  constructor(ws: RobustWebSocket, onUpdate: (msgs: Message[]) => void) {
    this.ws = ws;
    this.onUpdate = onUpdate;

    // ç›‘å¬æœåŠ¡ç«¯æ¶ˆæ¯
    this.ws.on("message", (data: ServerACK | ServerMessage) => {
      if (data.type === "ack") this.handleACK(data);
      if (data.type === "message") this.handleIncoming(data);
    });

    // é‡è¿åè‡ªåŠ¨æ‹‰å–ç¦»çº¿æ¶ˆæ¯
    this.ws.on("open", () => this.syncOfflineMessages());
  }

  // â”€â”€ å‘é€æ¶ˆæ¯ â”€â”€
  send(content: string): void {
    const msg: Message = {
      msgId: crypto.randomUUID(),
      content,
      timestamp: Date.now(),
      status: "pending",
    };

    this.messageList.push(msg);
    this.onUpdate(this.getSortedMessages());

    // å‘é€å¹¶å¯åŠ¨ ACK è¶…æ—¶è®¡æ—¶å™¨
    this.ws.send({ type: "send", msgId: msg.msgId, content: msg.content });

    const timer = window.setTimeout(
      () => this.handleTimeout(msg.msgId),
      this.ACK_TIMEOUT,
    );
    this.pendingMessages.set(msg.msgId, { msg, timer, retries: 0 });
  }

  // â”€â”€ å¤„ç† ACK å›æ‰§ â”€â”€
  private handleACK(ack: ServerACK): void {
    const pending = this.pendingMessages.get(ack.msgId);
    if (!pending) return;

    clearTimeout(pending.timer);
    this.pendingMessages.delete(ack.msgId);

    // ç”¨æœåŠ¡ç«¯ Seq æ›´æ–°æ¶ˆæ¯ï¼Œæ ‡è®°ä¸ºå·²ç¡®è®¤
    const msg = this.messageList.find((m) => m.msgId === ack.msgId);
    if (msg) {
      msg.seq = ack.seq;
      msg.status = "acked";
      this.localMaxSeq = Math.max(this.localMaxSeq, ack.seq);
    }

    this.onUpdate(this.getSortedMessages());
  }

  // â”€â”€ å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯ï¼ˆå»é‡ + æ’åºï¼‰ â”€â”€
  private handleIncoming(data: ServerMessage): void {
    // å¹‚ç­‰å»é‡ï¼šå·²å­˜åœ¨çš„æ¶ˆæ¯ç›´æ¥ä¸¢å¼ƒ
    if (this.messageCache.has(data.msgId)) return;

    this.messageCache.add(data.msgId);
    this.trimCache(); // é˜²æ­¢ç¼“å­˜æ— é™å¢é•¿

    const msg: Message = {
      msgId: data.msgId,
      seq: data.seq,
      content: data.content,
      timestamp: data.timestamp,
      status: "acked",
    };

    this.messageList.push(msg);
    this.localMaxSeq = Math.max(this.localMaxSeq, data.seq);

    // æŒ‰ Seq æ’åºåäº¤ç»™ UI
    this.onUpdate(this.getSortedMessages());
  }

  // â”€â”€ ACK è¶…æ—¶é‡å‘ â”€â”€
  private handleTimeout(msgId: string): void {
    const pending = this.pendingMessages.get(msgId);
    if (!pending) return;

    if (pending.retries < this.MAX_RETRIES) {
      pending.retries++;
      console.warn(`[MSG] æ¶ˆæ¯ ${msgId} ç¬¬ ${pending.retries} æ¬¡é‡å‘`);
      this.ws.send({ type: "send", msgId, content: pending.msg.content });

      pending.timer = window.setTimeout(
        () => this.handleTimeout(msgId),
        this.ACK_TIMEOUT,
      );
    } else {
      // è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ ‡è®°ä¸ºå¤±è´¥
      this.pendingMessages.delete(msgId);
      const msg = this.messageList.find((m) => m.msgId === msgId);
      if (msg) msg.status = "failed";
      this.onUpdate(this.getSortedMessages());
    }
  }

  // â”€â”€ ç¦»çº¿æ¶ˆæ¯æ‹‰å– â”€â”€
  private syncOfflineMessages(): void {
    this.ws.send({ type: "sync", lastSeq: this.localMaxSeq });
  }

  // â”€â”€ æŒ‰ Seq æ’åºï¼ˆæœªç¡®è®¤çš„æ¶ˆæ¯æ’åœ¨æœ€åï¼‰ â”€â”€
  private getSortedMessages(): Message[] {
    return [...this.messageList].sort((a, b) => {
      if (a.seq == null && b.seq == null) return a.timestamp - b.timestamp;
      if (a.seq == null) return 1; // pending æ’å
      if (b.seq == null) return -1;
      return a.seq - b.seq; // æŒ‰æœåŠ¡ç«¯ Seq æ’åº
    });
  }

  // â”€â”€ ç¼“å­˜æ¸…ç† â”€â”€
  private trimCache(): void {
    if (this.messageCache.size > this.CACHE_SIZE) {
      const iter = this.messageCache.values();
      this.messageCache.delete(iter.next().value!);
    }
  }
}
```

**æ¶ˆæ¯çŠ¶æ€æœº**ï¼š

```
  send()         æœåŠ¡ç«¯ ACK
 â”€â”€â”€â”€â”€â”€â†’ Pending â”€â”€â”€â”€â”€â”€â”€â”€â†’ Acked âœ“
            â”‚
            â”‚ è¶…æ—¶ï¼ˆâ‰¤3æ¬¡ï¼‰
            â”œâ”€â”€â”€â”€â”€â†’ é‡å‘ â†’ Pending ...
            â”‚
            â”‚ è¶…æ—¶ï¼ˆ>3æ¬¡ï¼‰
            â””â”€â”€â”€â”€â”€â†’ Failed âœ—
```

**æ¶ˆæ¯æ’åºçš„æœ¬è´¨**ï¼šå®¢æˆ·ç«¯æ—¶é—´ä¸å¯ä¿¡ï¼ˆè®¾å¤‡æ—¶é’Ÿåç§»ï¼‰ï¼ŒæœåŠ¡ç«¯ Seq æ˜¯å”¯ä¸€çš„å…¨åºå…³ç³»æ¥æºã€‚æœªè¢« ACK çš„æ¶ˆæ¯æ²¡æœ‰ Seqï¼Œæ‰€ä»¥åªèƒ½æš‚æ’é˜Ÿå°¾â€”â€”è¿™ä¸æ˜¯ bugï¼Œæ˜¯è®¾è®¡ã€‚

---

### 2.5.3 å®æ—¶æ•°æ®é«˜é¢‘æ›´æ–° (High-Frequency Updates) â­â­â­

**åœºæ™¯**ï¼šè‚¡ç¥¨ã€åšå½©ã€äº¤æ˜“æ‰€ã€‚æ¯ç§’å¯èƒ½æ”¶åˆ°æ•°åä¸ªæ•°æ®åŒ…ã€‚
**æœ¬è´¨**ï¼š**æ•°æ®æ¶ˆè´¹é€Ÿåº¦ä¸æ¸²æŸ“é¢‘ç‡çš„é€‚é…ã€‚**

#### ä¼˜åŒ–æ‰‹æ®µ

1.  **æ¸²æŸ“èŠ‚æµ (Batching)**ï¼šä¸è¦æ¯æ¥ä¸€æ¡æ¶ˆæ¯å°± `setState`ã€‚å°†æ•°æ®å­˜å…¥ç¼“å†²åŒºï¼ˆBufferï¼‰ï¼Œåˆ©ç”¨ `requestAnimationFrame` æ¯ 16ms è¿›è¡Œä¸€æ¬¡æ‰¹é‡ UI æ›´æ–°ã€‚
2.  **æ•°æ®é™é‡‡æ · (Downsampling)**ï¼šå¯¹äºéå±•ç¤ºæ ¸å¿ƒæ•°æ®çš„ç›‘æ§æµï¼Œå¯ä»¥åœ¨å‰ç«¯æŒ‰æ¯”ä¾‹ä¸¢å¼ƒé«˜é¢‘ä¸­é—´å€¼ï¼Œä»…å±•ç¤ºè¶‹åŠ¿ã€‚
3.  **å¢é‡æ›´æ–° (Delta)**ï¼šæœåŠ¡ç«¯ä»…å‘é€å˜åŒ–çš„éƒ¨åˆ†å­—æ®µï¼Œå‰ç«¯è¿›è¡Œæ·±åˆå¹¶ã€‚

#### å®Œæ•´å®ç°

```typescript
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  HighFrequencyDataStream â€” RAF æ‰¹é‡æ¸²æŸ“ + å¢é‡åˆå¹¶
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

type StockTick = {
  symbol: string;
  price: number;
  volume: number;
  change: number;
  timestamp: number;
};

// å¢é‡æ›´æ–°ï¼šåªä¼ å˜åŒ–çš„å­—æ®µ
type DeltaTick = Partial<StockTick> & { symbol: string };

class HighFrequencyDataStream {
  private buffer: DeltaTick[] = []; // å¸§é—´æ•°æ®ç¼“å†²åŒº
  private state = new Map<string, StockTick>(); // å…¨é‡çŠ¶æ€å¿«ç…§
  private rafId: number | null = null;
  private isScheduled = false;
  private onRender: (snapshot: Map<string, StockTick>) => void;

  // é™é‡‡æ ·æ§åˆ¶
  private sampleCounter = new Map<string, number>();
  private sampleRate: number; // æ¯ N æ¡å– 1 æ¡

  constructor(
    onRender: (snapshot: Map<string, StockTick>) => void,
    sampleRate = 1, // é»˜è®¤ä¸é™é‡‡æ ·
  ) {
    this.onRender = onRender;
    this.sampleRate = sampleRate;
  }

  // â”€â”€ æ•°æ®å…¥å£ï¼šæ¥æ”¶ WebSocket æ¨é€çš„å¢é‡æ•°æ® â”€â”€
  push(delta: DeltaTick): void {
    // é™é‡‡æ ·ï¼šéå…³é”®æ•°æ®æŒ‰æ¯”ä¾‹ä¸¢å¼ƒ
    if (this.sampleRate > 1) {
      const count = (this.sampleCounter.get(delta.symbol) ?? 0) + 1;
      this.sampleCounter.set(delta.symbol, count);
      if (count % this.sampleRate !== 0) return; // ç›´æ¥ä¸¢å¼ƒ
    }

    this.buffer.push(delta);
    this.scheduleFlush();
  }

  // â”€â”€ è°ƒåº¦ RAF æ¸²æŸ“ï¼ˆä¸€å¸§åªè°ƒåº¦ä¸€æ¬¡ï¼‰ â”€â”€
  private scheduleFlush(): void {
    if (this.isScheduled) return; // å½“å‰å¸§å·²æœ‰è°ƒåº¦ï¼Œæ— éœ€é‡å¤
    this.isScheduled = true;

    this.rafId = requestAnimationFrame(() => {
      this.flush();
      this.isScheduled = false;
    });
  }

  // â”€â”€ æ‰¹é‡åˆ·æ–°ï¼šå°†ç¼“å†²åŒºæ•°æ®åˆå¹¶è¿›å…¨é‡çŠ¶æ€ â”€â”€
  private flush(): void {
    if (this.buffer.length === 0) return;

    // éå†ç¼“å†²åŒºï¼Œæ‰§è¡Œå¢é‡åˆå¹¶ï¼ˆæ·±åˆå¹¶ï¼‰
    for (const delta of this.buffer) {
      const existing = this.state.get(delta.symbol);
      if (existing) {
        // å¢é‡åˆå¹¶ï¼šåªè¦†ç›–æœ‰å€¼çš„å­—æ®µ
        this.state.set(delta.symbol, { ...existing, ...delta });
      } else {
        // é¦–æ¬¡å‡ºç°çš„ symbolï¼Œéœ€è¦å®Œæ•´æ•°æ®
        this.state.set(delta.symbol, delta as StockTick);
      }
    }

    // æ¸…ç©ºç¼“å†²åŒº
    this.buffer.length = 0;

    // ä¸€æ¬¡æ€§è§¦å‘ UI æ›´æ–°
    this.onRender(new Map(this.state));
  }

  dispose(): void {
    if (this.rafId) cancelAnimationFrame(this.rafId);
    this.buffer.length = 0;
    this.state.clear();
  }
}

// â”€â”€ ä½¿ç”¨ç¤ºä¾‹ â”€â”€
const stream = new HighFrequencyDataStream(
  (snapshot) => {
    // è¿™é‡Œæ¯å¸§æœ€å¤šæ‰§è¡Œä¸€æ¬¡ï¼Œæ— è®ºæ•°æ®æ¥äº†å¤šå°‘æ¡
    renderStockTable(snapshot);
  },
  1, // sampleRate=1 è¡¨ç¤ºä¸é™é‡‡æ ·ï¼›è®¾ä¸º 5 åˆ™æ¯ 5 æ¡å– 1 æ¡
);

// WebSocket æ¯ç§’æ¨ 50 æ¡æ•°æ®ï¼Œä½† UI åªæŒ‰ ~60fps æ›´æ–°
ws.on("message", (data: DeltaTick) => stream.push(data));
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ             | æ¯ç§’ setState æ¬¡æ•° | å®é™… DOM æ›´æ–°æ¬¡æ•° | æ‰å¸§é£é™© |
| ---------------- | ------------------ | ----------------- | -------- |
| ç›´æ¥ setState    | 50+                | 50+               | ğŸ”´ ä¸¥é‡  |
| RAF æ‰¹é‡åˆå¹¶     | 50+ï¼ˆå…¥ç¼“å†²åŒºï¼‰    | ~60ï¼ˆè·Ÿå¸§ç‡èµ°ï¼‰   | ğŸŸ¢ æ—     |
| RAF + é™é‡‡æ ·(5x) | 10ï¼ˆå…¥ç¼“å†²åŒºï¼‰     | ~60               | ğŸŸ¢ æ—     |

> **æ ¸å¿ƒæ´å¯Ÿ**ï¼šäººçœ¼çš„åˆ·æ–°ç‡ä¸Šé™çº¦ 60fpsã€‚é«˜äºè¿™ä¸ªé¢‘ç‡çš„æ•°æ®æ›´æ–°å¯¹ç”¨æˆ·æ¥è¯´æ˜¯ä¸å¯æ„ŸçŸ¥çš„â€”â€”å®ƒä»¬ä¸æ˜¯"å®æ—¶"ï¼Œæ˜¯"æµªè´¹"ã€‚`requestAnimationFrame` æ˜¯æµè§ˆå™¨ä¸äººçœ¼ä¹‹é—´çš„å¥‘çº¦ï¼šä½ ç»™æˆ‘æ•°æ®ï¼Œæˆ‘åªåœ¨éœ€è¦ç”»ç”»çš„æ—¶å€™æ‰çœ‹ä¸€çœ¼ã€‚

---

## ä¸‰å¤§åœºæ™¯çš„ç»Ÿä¸€ç¼–æ’

```typescript
// â”€â”€ ä¸€ä¸ªå®Œæ•´çš„å®æ—¶é€šä¿¡ç³»ç»Ÿçš„åˆå§‹åŒ– â”€â”€

const ws = RobustWebSocket.getInstance({
  url: "wss://api.example.com/ws",
  heartbeatInterval: 30_000,
  heartbeatTimeout: 5_000,
});

// æ¶ˆæ¯å¯é æ€§å±‚
const chat = new ReliableMessageChannel(ws, (messages) => {
  renderChatUI(messages);
});

// é«˜é¢‘æ•°æ®å±‚
const ticker = new HighFrequencyDataStream((snapshot) => {
  renderStockTable(snapshot);
});

ws.on("message", (data) => {
  if (data.channel === "chat") chat.handleIncoming(data);
  if (data.channel === "ticker") ticker.push(data);
});
```

```
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚            RobustWebSocket              â”‚
 â”‚   å¿ƒè·³ä¿æ´» Â· æŒ‡æ•°é€€é¿ Â· å•ä¾‹å®ˆå«        â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼                 â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ Reliable  â”‚    â”‚ HighFrequencyâ”‚
 â”‚ Message   â”‚    â”‚ DataStream   â”‚
 â”‚ Channel   â”‚    â”‚              â”‚
 â”‚           â”‚    â”‚ RAF æ‰¹é‡æ¸²æŸ“  â”‚
 â”‚ ACK/å»é‡  â”‚    â”‚ å¢é‡åˆå¹¶      â”‚
 â”‚ æ’åº/è¡¥å‘ â”‚    â”‚ é™é‡‡æ ·        â”‚
 â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼                 â–¼
   Chat UI          Stock Table
```

---

## å“²å­¦å¯ç¤º

å®æ—¶é€šä¿¡çš„æœ€é«˜å¢ƒç•Œæ˜¯ **"å‡æ€§åœ¨çº¿ (Pseudonline)"**ï¼šåœ¨ç‰©ç†è¿æ¥æ–­å¼€æ—¶ï¼Œé€šè¿‡æœ¬åœ°ç¼“å­˜ä¸åŠ è½½çŠ¶æ€è’™è”½ç”¨æˆ·ï¼›åœ¨ç‰©ç†è¿æ¥æ¢å¤æ—¶ï¼Œé€šè¿‡é™é»˜è¡¥å‘ä¸å·®å¼‚åŒæ­¥æ¶ˆå¼­æ–­å±‚ã€‚

> TCP ç»™äº†ä½ "å¯é ä¼ è¾“"çš„å¹»è§‰ï¼ŒWebSocket ç»™äº†ä½ "å®æ—¶è¿æ¥"çš„å¹»è§‰ã€‚è€Œæˆ‘ä»¬çš„å·¥ä½œï¼Œæ˜¯åœ¨è¿™ä¸¤å±‚å¹»è§‰ä¹‹ä¸Šï¼Œå†å åŠ ç¬¬ä¸‰å±‚å¹»è§‰â€”â€”**æ°¸ä¸æ–­çº¿çš„ç”¨æˆ·ä½“éªŒ**ã€‚ä¸‰å±‚å¹»è§‰å åŠ ï¼Œä¾¿æ˜¯çœŸå®ã€‚
