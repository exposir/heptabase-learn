<!--
- [INPUT]: WebSocket 协议、心跳保活、指数退避重连、消息幂等
- [OUTPUT]: 高可用、强可靠的实时通信系统前端实现规范
- [POS]: 编程题/ 模块的核心专题，解决实时数据的一致性与稳定性
- [PROTOCOL]: 变更时更新此头部，然后检查 CLAUDE.md
-->

# 2.5 实时通信场景深度剖析

实时通信（Real-time Communication）的核心挑战在于网络状态的不可测性。**实时通信的本质是：在一个不可靠的长连接上，通过“确认机制（ACK）”与“状态自愈（Recovery）”来模拟一个确定性的双向同步通道。**

---

### 2.5.1 WebSocket 链接稳定性管理 ⭐⭐⭐

**现象**：WebSocket 会因网络切换、锁屏、运营商清理等原因在无感知的情况下断开。
**本质**：建立 **应用层探活机制**。

#### 核心治理方案
1.  **心跳保活 (Heartbeat)**：定时发送 `Ping` 包。若在规定时间内未收到 `Pong`，主动判定连接已断开并执行重连。
2.  **指数退避重连 (Exponential Backoff)**：重连时间间隔应按 `1s, 2s, 4s, 8s...` 增加，并加入随机扰动（Jitter），防止服务器因大量客户端同时重连而崩溃。
3.  **多实例屏蔽**：单例模式封装，防止页面开启多个长连接。

---

### 2.5.2 消息可靠性保证 (Message Reliability) ⭐⭐⭐

**场景**：IM 消息必须做到“不丢、不重、不乱序”。
**本质**：引入 **版本号（Sequence）与回执（ACK）** 系统。

#### 关键技术实现
*   **去重 (Deduplication)**：每条消息携带客户端生成的唯一 `msgId`。服务端与客户端均维护近期消息 ID 缓存，丢弃重复消息。
*   **排序 (Ordering)**：基于服务端返回的单调递增序列号（Seq）进行 UI 排序，解决网络乱序导致的对话错乱。
*   **消息 ACK 与补发**：客户端发送消息后进入 `Pending` 状态，若在超时时间内未收到服务端的 ACK 确认，则触发重发机制。
*   **离线拉取 (Sync)**：连接重连后，携带本地最高 Seq 向服务端拉取断线期间的差异消息。

---

### 2.5.3 实时数据高频更新 (High-Frequency Updates) ⭐⭐⭐

**场景**：股票、博彩、交易所。每秒可能收到数十个数据包。
**本质**：**数据消费速度与渲染频率的适配。**

#### 优化手段
1.  **渲染节流 (Batching)**：不要每来一条消息就 `setState`。将数据存入缓冲区（Buffer），利用 `requestAnimationFrame` 每 16ms 进行一次批量 UI 更新。
2.  **数据降采样 (Downsampling)**：对于非展示核心数据的监控流，可以在前端按比例丢弃高频中间值，仅展示趋势。
3.  **增量更新 (Delta)**：服务端仅发送变化的部分字段，前端进行深合并。

---

## 哲学启示

实时通信的最高境界是 **“假性在线 (Pseudonline)”**：在物理连接断开时，通过本地缓存与加载状态蒙蔽用户；在物理连接恢复时，通过静默补发与差异同步消弭断层。
