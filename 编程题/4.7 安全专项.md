<!--
- [INPUT]: 依赖网络安全与浏览器安全机制
- [OUTPUT]: 前端安全攻击与防御全景
- [POS]: 编程题模块 - 安全专项
- [PROTOCOL]: 变更时更新此头部，然后检查 /CLAUDE.md
-->

# 4.7 安全专项

安全不是"加个功能"，而是"少犯个错误"。前端安全的本质是 **信任边界管理**。

---

## 4.7.1 前端安全完整图谱 ⭐⭐⭐

| 攻击           | 防御                |
| :------------- | :------------------ |
| **XSS**        | 转义、CSP、HttpOnly |
| **CSRF**       | Token、SameSite     |
| **点击劫持**   | X-Frame-Options     |
| **中间人**     | HTTPS               |
| **敏感信息**   | 不落日志、脱敏      |
| **第三方脚本** | 沙箱、CSP           |

### 1. XSS 防御全链路

```javascript
// ─────────────────────────────────────────────────
//  XSS Defense — 跨站脚本攻击防御
// ─────────────────────────────────────────────────

// ── 攻击示例：存储型 XSS ────────────────────────
// 用户在评论区提交：<script>document.cookie</script>
// 服务端原样存储，其他用户浏览时脚本执行 → Cookie 被盗

// ── 防御 1: HTML 实体转义（最基础） ─────────────
function escapeHTML(str) {
  const escapeMap = {
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#x27;",
    "/": "&#x2F;",
  };
  return str.replace(/[&<>"'/]/g, (char) => escapeMap[char]);
}

// ── 防御 2: CSP 内容安全策略 ────────────────────
// HTTP 响应头设置：
// Content-Security-Policy: default-src 'self';
//   script-src 'self' 'nonce-abc123';
//   style-src 'self' 'unsafe-inline';
//   img-src 'self' data: https://cdn.example.com;

// 页面中只有携带 nonce 的脚本才能执行：
// <script nonce="abc123">安全的代码</script>
// <script>恶意代码——不执行</script>

// ── 防御 3: HttpOnly Cookie ─────────────────────
// Set-Cookie: session=abc; HttpOnly; Secure; SameSite=Strict
// HttpOnly → JS 无法通过 document.cookie 读取
// Secure → 只在 HTTPS 下传输
// SameSite=Strict → 跨站请求不携带

// ── 防御 4: DOM XSS 防护（React 自带） ─────────
// React 默认对 JSX 中的变量做转义
// 危险 API：dangerouslySetInnerHTML（必须手动清理输入）

// DOMPurify：安全的 HTML 渲染库
import DOMPurify from "dompurify";
const cleanHTML = DOMPurify.sanitize(userInput);
```

### 2. CSRF 防御

```javascript
// ─────────────────────────────────────────────────
//  CSRF Defense — 跨站请求伪造防御
// ─────────────────────────────────────────────────

// ── 攻击原理 ────────────────────────────────────
// 恶意网站 evil.com 中：
// <img src="https://bank.com/transfer?to=hacker&amount=10000" />
// 用户已登录 bank.com → 浏览器自动携带 Cookie → 转账成功

// ── 防御 1: CSRF Token ──────────────────────────
// 服务端生成随机 Token，嵌入表单隐藏字段或 HTTP 头
class CSRFProtection {
  constructor() {
    this.token = this._getTokenFromMeta();
  }

  _getTokenFromMeta() {
    // 从 <meta name="csrf-token" content="xxx"> 读取
    return document.querySelector('meta[name="csrf-token"]')?.content;
  }

  // 每个请求携带 Token
  async fetch(url, options = {}) {
    return fetch(url, {
      ...options,
      headers: {
        ...options.headers,
        "X-CSRF-Token": this.token,
      },
    });
  }
}

// ── 防御 2: SameSite Cookie（最简单有效） ───────
// Set-Cookie: session=abc; SameSite=Lax
// Lax: GET 导航允许, POST 阻止（推荐）
// Strict: 所有跨站请求都不携带
// None: 都携带（必须配合 Secure）

// ── 防御 3: Origin / Referer 检查 ──────────────
function validateOrigin(req) {
  const origin = req.headers.origin || req.headers.referer;
  const allowed = ["https://mysite.com", "https://www.mysite.com"];
  return allowed.some((o) => origin?.startsWith(o));
}
```

### 3. 点击劫持防御

```javascript
// ─────────────────────────────────────────────────
//  Clickjacking Defense — 点击劫持防御
// ─────────────────────────────────────────────────

// ── 攻击原理 ────────────────────────────────────
// 攻击者把你的网站放在 iframe 中，覆盖透明层诱导用户点击

// ── 防御 1: HTTP 响应头 ─────────────────────────
// X-Frame-Options: DENY              → 完全禁止被嵌入
// X-Frame-Options: SAMEORIGIN        → 只允许同源嵌入
// Content-Security-Policy: frame-ancestors 'self'  → 更灵活的 CSP

// ── 防御 2: JS 检测（兜底） ────────────────────
if (window.top !== window.self) {
  // 页面被嵌入到 iframe 中
  window.top.location = window.self.location; // 强制跳出
}
```

### 4. 敏感信息保护

```javascript
// ─────────────────────────────────────────────────
//  SensitiveDataProtection — 敏感信息脱敏
// ─────────────────────────────────────────────────

class DataMasker {
  // 手机号脱敏：138****1234
  static maskPhone(phone) {
    return phone.replace(/(\d{3})\d{4}(\d{4})/, "$1****$2");
  }

  // 身份证脱敏：110***********1234
  static maskIdCard(id) {
    return id.replace(/(\d{3})\d+(\d{4})/, "$1***********$2");
  }

  // 邮箱脱敏：u***@example.com
  static maskEmail(email) {
    return email.replace(/(.{1})(.+)(@.+)/, "$1***$3");
  }

  // 银行卡脱敏：**** **** **** 1234
  static maskBankCard(card) {
    return card.replace(/\d{12}(\d{4})/, "**** **** **** $1");
  }
}

// ── 日志安全：防止敏感信息进入 console ──────────
const originalLog = console.log;
console.log = (...args) => {
  const sanitized = args.map((arg) => {
    if (typeof arg === "string") {
      // 自动脱敏手机号、身份证号
      return arg
        .replace(/\d{11}/g, (m) => DataMasker.maskPhone(m))
        .replace(/\d{18}/g, (m) => DataMasker.maskIdCard(m));
    }
    return arg;
  });
  originalLog.apply(console, sanitized);
};

// ── 网络请求安全 ────────────────────────────────
// 1. 不在 URL 中传递敏感参数（会进入浏览器历史和日志）
// ❌ /login?password=123456
// ✅ POST body 传输

// 2. 不在 localStorage 存储 Token（XSS 可读取）
// ✅ 使用 HttpOnly Cookie
```

### 5. 第三方脚本沙箱

```javascript
// ─────────────────────────────────────────────────
//  ScriptSandbox — 第三方脚本隔离
// ─────────────────────────────────────────────────

class ScriptSandbox {
  constructor(name) {
    this.name = name;
    // 用 iframe 创建隔离环境
    this.iframe = document.createElement("iframe");
    this.iframe.style.display = "none";
    this.iframe.sandbox = "allow-scripts"; // 严格沙箱
    document.body.appendChild(this.iframe);
  }

  // 在沙箱中执行代码
  exec(code) {
    const win = this.iframe.contentWindow;
    try {
      win.eval(code);
    } catch (e) {
      console.error(`[Sandbox:${this.name}] Error:`, e.message);
    }
  }

  // 安全通信：postMessage
  onMessage(handler) {
    window.addEventListener("message", (e) => {
      if (e.source === this.iframe.contentWindow) {
        handler(e.data);
      }
    });
  }

  destroy() {
    this.iframe.remove();
  }
}

// CSP 中限制第三方脚本域名
// Content-Security-Policy: script-src 'self' https://trusted-cdn.com
```

> **本质洞察**：前端安全的核心原则是 **「永远不要信任用户输入」** 和 **「永远不要信任客户端状态」**。XSS 的本质是 **代码注入**（数据被当作代码执行），CSRF 的本质是 **身份冒用**（利用浏览器自动携带 Cookie 的机制），点击劫持的本质是 **视觉欺骗**。三种攻击对应三种信任边界的失守：**输入边界、身份边界、视觉边界**。安全防御就是在每条边界上筑墙。

---

## 质量指标

- **攻击面覆盖**：是否对全部 OWASP Top 10 相关的前端攻击有防御。
- **防御深度**：是否形成多层防御（Defense in Depth），而非依赖单一措施。
- **安全审计**：是否有自动化的安全扫描和第三方依赖漏洞检测。
