<!--
- [INPUT]: Window Error Listeners, Performance API, Beacon API, SourceMap Algorithms
- [OUTPUT]: 监控系统 SDK 设计要求，涵盖错误捕获、性能指标及埋点上报策略
- [POS]: 编程题/ 复杂场景专题，聚焦系统可观测深度与数据采集稳定性
- [PROTOCOL]: 变更时更新此头部，然后检查 CLAUDE.md
-->

# 3.7 监控与可观测性

监控 SDK 是系统在线上的"黑匣子"，它决定了我们在面对故障时是"盲目猜测"还是"精准打击"。

---

### 3.7.1 错误监控 SDK 开发 ⭐⭐⭐⭐

**要求：** 设计一个无死角捕获应用运行时错误的底层监控库。

- **核心技术指标：**
  - **JS 运行时错误**：通过 `window.onerror` 与 `error` 事件捕获处理各类异常。
  - **异步错误处理**：监听 `unhandledrejection` 处理未捕获的 Promise 异常。
  - **资源加载故障**：识别脚本、样式或图片加载失败的精准归因。
  - **接口稳定性劫持**：拦截并包装 `fetch` 与 `XHR`，捕获 HTTP 状态码与耗时。
  - **SourceMap 堆栈还原**：设计在服务端还原压缩代码真实堆栈的基础流程。
  - **错误指纹与聚合**：根据错误特征进行自动去重与指纹计算，防止报警风暴。
  - **行为记录 (Breadcrumbs)**：记录用户崩溃前的操作队列，实现场景回溯。

---

### 3.7.2 性能监控 (Performance Core) ⭐⭐⭐

**要求：** 实现对用户核心感知指标的自动化采集与上报。

- **指标挑战：**
  - **Web Vitals 采集**：精准测量 FCP, LCP, CLS, FID 及最新的 INP 指标。
  - **长任务监听**：利用 `PerformanceObserver` 识别阻塞主线程的 Long Task（>50ms）。
  - **资源加载瀑布流**：分析关键资源（Bundle, Font）的加载耗时与优先级。
  - **自定义业务打点**：设计支持全链路时间戳打点的 API。

---

### 3.7.3 埋点 SDK 与稳定性设计 ⭐⭐⭐

**要求：** 构建一个兼顾灵活性与上报稳定性的埋点数据采集引擎。

- **设计要求：**
  - **采集策略选择**：对比研究"声明式埋点"与"手动注入式埋点"的架构实现。
  - **自动化曝光检测**：基于 `IntersectionObserver` 的高性能元素可见度判定。
  - **上报稳定性保障**：
    - 优先使用 `navigator.sendBeacon` 解决页面卸载时的上报丢失。
    - 批量聚合上报策略，平衡 HTTP 请求频率与实时性。
    - 离线存储机制：利用 `IndexedDB` 暂存弱网环境下的数据。

---

## 质量指标

- **自愈性**：监控 SDK 本身是否会因为自身代码缺陷导致用户业务崩溃。
- **采集损耗**：监控逻辑对主线程 (Main Thread) 性能的侵入性评价。
- **数据准确性**：对移动端、弱网及极端环境下的上报成功率（P99）。
