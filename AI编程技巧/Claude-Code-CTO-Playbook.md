<!--
- [INPUT]: CTO 视角下的 Claude Code 深度使用指南
- [OUTPUT]: 格式化后的企业级 Agent 开发手册与最佳实践
- [POS]: AI编程技巧/ 模块，作为 AI 协作的高级方法论支撑
- [PROTOCOL]: 变更时更新此头部，然后检查 CLAUDE.md
-->

# Claude Code 深度使用手册：CTO 的企业级实战指南

> **前言**：本文总结自一位拥有 Amazon、Disney 等大厂背景的 CTO 实战经验。核心观点：AI 协作的瓶颈不在模型，而在人类的输入质量与系统构建能力。

---

## 一、 核心法则：先思考，再敲击 (Think First)

**这是 10/10 的成功概率保证。** 

*   **Plan Mode 是神**：直接对话的效果远不如 Plan Mode（`Shift + Tab` 二次进入）。
*   **架构定义**：不要只给目标，要给约束。
    *   *坏输入*：“帮我写个鉴权系统。”
    *   *好输入*：“使用现有 User 模型构建 Email/Password 鉴权，Session 存入 Redis（24h 过期），添加中间件保护 `/api/protected` 下的所有路由。”
*   **博弈式思考**：如果你不具备架构能力，先去和 ChatGPT/Gemini/Claude 进行深度的“往复式对话”，直到理清系统设计方案，再交给 Claude Code 执行。

---

## 二、 核心资产：CLAUDE.md (项目宪法)

`CLAUDE.md` 不是给新人的文档，而是**给“明天就会失忆”的你写的备忘录**。

1.  **保持精简**：维持在 150-200 条指令以内。Claude Code 的系统提示词已占用约 50 条，信息过载会导致模型随机忽略指令。
2.  **解释“为什么” (The Why)**：不仅说“使用 TypeScript 严格模式”，要说“因为我们曾因 implicit any 导致过生产事故”。这能帮助 Claude 在遇到模糊地带时做出正确的判断。
3.  **动态演进**：使用 `#` 键让 Claude 自动添加指令。每当你发现自己在重复纠正 Claude 同一个错误时，就是该更新 `CLAUDE.md` 的时候了。

---

## 三、 内存管理：上下文衰减法则

**模型在 Context 达到 20%-40% 时就开始性能下降，而非 100%。**

*   **单一职责对话**：一个对话只处理一个功能。不要在一个对话里同时写鉴权和重构数据库，上下文会“污染”。
*   **外部记忆 (External Memory)**：让 Claude 将进度和计划写入 `SCRATCHPAD.md` 或 `plan.md`。这些文件是跨 Session 持续存在的。
*   **复制粘贴重置法 (The Reset)**：当上下文臃肿时，复制终端重要信息 -> `/compact` 总结 -> `/clear` 清空 -> 粘贴关键信息。

---

## 四、 进阶配置：构建系统而非孤岛

1.  **Hooks (钩子)**：
    *   Prettier 自动格式化。
    *   每次编辑后自动运行类型检查 (`tsc`)。
    *   这是消除技术债的自动机。
2.  **Headless Mode (-p flag)**：
    *   利用脚本运行 Claude。
    *   集成到 CI/CD 进行自动 PR 评审、自动日志更新。
3.  **自定义命令 (Custom Slash Commands)**：
    *   在 `.claude/commands` 中创建 Markdown 文件。
    *   将重复的 Debug 或 Review 逻辑封装为 `/your-command`。

---

## 五、 破局：当 Claude 陷入死循环时

1.  **直接清空 (`/clear`)**：90% 的错乱源于上下文污染。
2.  **简化任务**：如果 Claude 搞不定复杂任务，说明你的 Plan Mode 规划不到位，拆解它。
3.  **以身作则 (Show, don't tell)**：自己写一个最小化的代码示例，“这是我们要的范式，照着做”。
4.  **重新框架化**：尝试不同的表述，例如将“处理这些状态转换”改为“实现一个状态机”。

---

## 六、 总结：TL;DR

*   **规划 > 编写**。
*   **CLAUDE.md 是杠杆**。
*   **30% 上下文是预警线**。
*   **架构决定产出**。
*   **Bad Input == Bad Output**。

---

> **结语**：AI 是为了加速专业的软件工程，而非取代它。如果你能识别并纠正 AI 的错误，你将无往不利。
